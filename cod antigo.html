<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASM Gest√£o Cl√≠nica</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f0f2f5}
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#1e3a5f 0%,#2c5282 100%)}
.login-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);width:90%;max-width:400px;text-align:center}
.login-box h1{color:#1e3a5f;margin-bottom:10px;font-size:28px}
.login-box h2{color:#666;font-size:18px;margin-bottom:30px;font-weight:normal}
.login-box .form-group{margin-bottom:20px;text-align:left}
.login-box input{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px}
.login-btn{width:100%;padding:14px;background:#1e3a5f;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-weight:bold}
.login-btn:hover{background:#2c5282}
.login-error{color:#e53e3e;margin-top:15px;display:none;font-size:14px}
.header{background:#1e3a5f;color:white;padding:15px;text-align:center}
.user-bar{background:#152a45;color:white;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
.user-bar button{background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 15px;border-radius:5px;cursor:pointer}
.user-bar button:hover{background:rgba(255,255,255,0.3)}
.nav{display:flex;justify-content:center;gap:10px;padding:10px;background:#2c5282;flex-wrap:wrap}
.nav button{padding:10px 20px;border:none;background:rgba(255,255,255,0.2);color:white;border-radius:5px;cursor:pointer;font-size:14px}
.nav button:hover,.nav button.active{background:white;color:#1e3a5f}
.container{max-width:1200px;margin:20px auto;padding:0 20px}
.section{display:none;background:white;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.section.active{display:block}
.btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:14px;margin:5px;font-weight:bold}
.btn-primary{background:#1e3a5f;color:white}
.btn-primary:hover{background:#2c5282}
.btn-success{background:#38a169;color:white}
.btn-success:hover{background:#2f855a}
.btn-danger{background:#e53e3e;color:white}
.btn-danger:hover{background:#c53030}
.btn-whatsapp{background:#25d366;color:white}
.btn-whatsapp:hover{background:#128c7e}
.btn-warning{background:#d69e2e;color:white}
.btn-warning:hover{background:#b7791f}
.btn-pdf{background:#e53e3e;color:white}
.btn-pdf:hover{background:#c53030}
.btn-info{background:#3182ce;color:white}
.btn-info:hover{background:#2c5282}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#2d3748}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #cbd5e0;border-radius:5px;font-size:14px}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#1e3a5f}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
.card{background:white;padding:15px;border-radius:8px;border:2px solid #e2e8f0;cursor:pointer;transition:all 0.3s}
.card:hover{border-color:#1e3a5f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:20px}
.calendar-header{text-align:center;font-weight:bold;padding:10px;background:#1e3a5f;color:white;border-radius:5px}
.calendar-day{background:#f7fafc;min-height:100px;padding:10px;border-radius:5px;cursor:pointer;border:1px solid #e2e8f0}
.appointment{background:#1e3a5f;color:white;padding:5px;margin:2px 0;border-radius:3px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
.appointment.cancelled{background:#a0aec0;text-decoration:line-through;opacity:0.7}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:white;padding:30px;border-radius:10px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #e2e8f0;padding-bottom:10px}
.close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#718096}
.close-btn:hover{color:#1e3a5f}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #e2e8f0}
th{background:#f7fafc;font-weight:bold;color:#2d3748}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
.summary-card{padding:20px;border-radius:10px;text-align:center;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
.summary-card.green{background:#38a169}
.summary-card.red{background:#e53e3e}
.summary-card.blue{background:#1e3a5f}
.summary-card.purple{background:#805ad5}
.tabs{display:flex;gap:10px;margin-bottom:20px;border-bottom:2px solid #e2e8f0;flex-wrap:wrap}
.tab{padding:10px 20px;background:none;border:none;cursor:pointer;color:#4a5568;font-weight:bold}
.tab.active{color:#1e3a5f;border-bottom:2px solid #1e3a5f}
.tab-content{display:none}
.tab-content.active{display:block}
.settings-box{background:#ebf8ff;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #1e3a5f}
.footer{text-align:center;padding:20px;background:#1e3a5f;color:white;margin-top:40px;font-size:12px}
.session-checkbox{margin-right:10px;transform:scale(1.2)}
.session-row{cursor:pointer;transition:background 0.2s}
.session-row:hover{background:#ebf8ff}
.session-row.selected{background:#bee3f8}
.report-box{background:#f7fafc;padding:20px;border-radius:8px;white-space:pre-wrap;font-family:monospace;margin:20px 0;max-height:400px;overflow-y:auto;border:1px solid #e2e8f0;font-size:13px}
.financial-row{cursor:pointer;transition:background 0.2s}
.financial-row:hover{background:#ebf8ff}
.financial-row.selected{background:#bee3f8}

/* TELA DE ATIVA√á√ÉO */
.activation-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1e3a5f 0%,#2c5282 100%)}
.activation-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);width:90%;max-width:450px;text-align:center}
.activation-box h2{color:#1e3a5f;margin-bottom:15px;font-size:24px}
.activation-box p{color:#4a5568;margin-bottom:25px;font-size:14px}
.code-input{width:100%;padding:15px;font-size:20px;text-align:center;letter-spacing:3px;border:2px solid #cbd5e0;border-radius:8px;margin-bottom:15px;text-transform:uppercase;font-weight:bold}
.code-input:focus{outline:none;border-color:#1e3a5f}
.cpf-input{width:100%;padding:15px;font-size:18px;text-align:center;border:2px solid #cbd5e0;border-radius:8px;margin-bottom:20px;font-weight:bold}
.cpf-input:focus{outline:none;border-color:#1e3a5f}
.activation-error{color:#e53e3e;margin-top:10px;display:none;font-size:14px;padding:10px;background:#fed7d7;border-radius:5px}
.activation-success{color:#38a169;margin-top:10px;display:none;font-size:14px;padding:10px;background:#c6f6d5;border-radius:5px}
.loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #1e3a5f;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.info-box{background:#ebf8ff;padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;font-size:13px;color:#2c5282;border-left:4px solid #1e3a5f}
.info-box strong{color:#1e3a5f}

/* BOT√ïES DE ABAS DO PACIENTE */
.patient-tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;justify-content:center}
.patient-tab-btn{padding:15px 20px;border:2px solid #e2e8f0;background:white;border-radius:10px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s;display:flex;flex-direction:column;align-items:center;gap:5px;min-width:120px}
.patient-tab-btn:hover{border-color:#1e3a5f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.patient-tab-btn.active{background:#1e3a5f;color:white;border-color:#1e3a5f}
.patient-tab-btn .emoji{font-size:24px}
.patient-tab-btn .label{font-size:12px}
</style>
</head>
<body>

<!-- TELA DE ATIVA√á√ÉO (√öNICA TELA DE ENTRADA) -->
<div id="activationScreen" class="activation-container">
<div class="activation-box">
<h2>üîê Ativa√ß√£o do Sistema</h2>
<p>Bem-vindo √† ASM Gest√£o Cl√≠nica</p>

<div class="info-box">
<strong>Como funciona:</strong><br>
‚Ä¢ Digite seu CPF (somente n√∫meros)<br>
‚Ä¢ Digite o c√≥digo de ativa√ß√£o fornecido<br>
‚Ä¢ Formato do c√≥digo: AA + 6 n√∫meros<br>
‚Ä¢ Exemplo: AA123456
</div>

<div class="form-group" style="text-align:left">
<label style="font-weight:bold;color:#2d3748;margin-bottom:5px;display:block">CPF</label>
<input type="text" class="cpf-input" id="userCPF" placeholder="000.000.000-00" maxlength="14">
</div>

<div class="form-group" style="text-align:left">
<label style="font-weight:bold;color:#2d3748;margin-bottom:5px;display:block">C√≥digo de Ativa√ß√£o</label>
<input type="text" class="code-input" id="activationCode" placeholder="AA000000" maxlength="8">
</div>

<button class="login-btn" id="activateBtn" onclick="activateSystem()">Ativar Sistema</button>

<div class="activation-error" id="activationError"></div>
<div class="activation-success" id="activationSuccess">Sistema ativado com sucesso! Redirecionando...</div>

<div id="activationLoading" style="display:none;margin-top:15px">
<div class="loading"></div>
<p style="margin-top:10px;color:#4a5568">Verificando c√≥digo...</p>
</div>

<p style="margin-top:20px;font-size:12px;color:#718096">
¬© 2024 ASM Gest√£o Cl√≠nica - Dra. Andresa Augusto<br>
Proibida reprodu√ß√£o sem autoriza√ß√£o
</p>
</div>
</div>

<!-- SISTEMA PRINCIPAL -->
<div id="mainSystem" style="display:none">
<div class="header">
<h1>üè• ASM Gest√£o Cl√≠nica</h1>
<p id="headerSubtitle">Sistema de Gest√£o para Profissionais da Sa√∫de</p>
</div>

<div class="user-bar">
<div>üë§ <span id="currentUserName">Profissional</span> | <span id="currentUserRegistry">---</span></div>
<div><button onclick="logout()">üö™ Sair</button></div>
</div>

<div class="nav">
<button class="active" onclick="showSection('agenda')">üìÖ Agenda</button>
<button onclick="showSection('pacientes')">üë• Pacientes</button>
<button onclick="showSection('financeiro')">üí∞ Financeiro</button>
<button onclick="showSection('fluxo')">üìä Fluxo de Caixa</button>
<button onclick="showSection('relatorios')">üìà Relat√≥rios</button>
<button onclick="showSection('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
</div>

<div class="container">

<!-- CONFIGURA√á√ïES -->
<div id="configuracoes" class="section">
<h2>‚öôÔ∏è Configura√ß√µes do Profissional</h2>
<div class="settings-box">
<div class="form-group">
<label>Profiss√£o *</label>
<select id="configProfession" onchange="updateRegistryLabel()">
<option value="">Selecione sua profiss√£o...</option>
<option value="fisioterapia">Fisioterapia</option>
<option value="medicina">Medicina</option>
<option value="nutricao">Nutri√ß√£o</option>
<option value="psicologia">Psicologia</option>
<option value="psicopedagogia">Psicopedagogia</option>
<option value="fonoaudiologia">Fonoaudiologia</option>
<option value="terapia_ocupacional">Terapia Ocupacional</option>
<option value="estetica">Est√©tica</option>
<option value="enfermagem">Enfermagem</option>
<option value="odontologia">Odontologia</option>
<option value="educacao_fisica">Educa√ß√£o F√≠sica</option>
</select>
</div>
<div class="form-group"><label>Nome do Profissional *</label><input type="text" id="configName" placeholder="Dr(a). Nome Completo"></div>
<div class="form-group"><label id="registryLabel">CREFITO *</label><input type="text" id="configRegistry" placeholder="00 0000 F"></div>
<div class="form-group"><label>Nome da Cl√≠nica/Empresa</label><input type="text" id="configClinic" placeholder="ASM Sa√∫de"></div>
<div class="form-group"><label>Chave Pix</label><input type="text" id="configPix" placeholder="CPF, CNPJ, e-mail ou telefone"></div>
<button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar Configura√ß√µes</button>
</div>

<div style="margin-top:30px;padding:20px;background:#f7fafc;border-radius:8px">
<h3 style="color:#1e3a5f;margin-bottom:15px">‚ÑπÔ∏è Informa√ß√µes da Conta</h3>
<p><strong>CPF vinculado:</strong> <span id="displayCPF">---</span></p>
<p><strong>C√≥digo de ativa√ß√£o:</strong> <span id="displayCode">---</span></p>
<p style="margin-top:10px;font-size:12px;color:#718096">Seus dados s√£o salvos automaticamente na nuvem e podem ser acessados de qualquer dispositivo.</p>
</div>
</div>

<!-- AGENDA -->
<div id="agenda" class="section active">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2>üìÖ Agenda</h2>
<button class="btn btn-primary" onclick="openAppointmentModal()">+ Novo Agendamento</button>
</div>
<div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px;align-items:center">
<button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê Anterior</button>
<h3 id="currentMonth" style="text-transform:capitalize;min-width:200px;text-align:center"></h3>
<button class="btn btn-primary" onclick="changeMonth(1)">Pr√≥ximo ‚Üí</button>
</div>
<div class="calendar" id="calendar"></div>
</div>

<!-- PACIENTES -->
<div id="pacientes" class="section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2>üë• Pacientes</h2>
<button class="btn btn-primary" onclick="openPatientModal()">+ Novo Paciente</button>
</div>
<input type="text" style="width:100%;padding:10px;margin-bottom:20px;border:1px solid #cbd5e0;border-radius:5px" placeholder="üîç Buscar paciente..." oninput="searchPatients(this.value)">
<div class="grid" id="patientsList"></div>
</div>

<!-- FINANCEIRO -->
<div id="financeiro" class="section">
<h2>üí∞ Financeiro</h2>
<div class="summary-cards">
<div class="summary-card green"><h3 id="totalReceived">R$ 0,00</h3><p>Recebido</p></div>
<div class="summary-card red"><h3 id="totalPending">R$ 0,00</h3><p>A Receber</p></div>
<div class="summary-card blue"><h3 id="totalSessions">0</h3><p>Total de Atendimentos</p></div>
</div>
<div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap">
<button class="btn btn-whatsapp" onclick="sendSelectedPendingWhatsApp()" id="btnCobrarSelecionados" style="display:none">
üì± Cobrar Selecionados (<span id="selectedCount">0</span>)
</button>
<button class="btn btn-primary" onclick="selectAllPending()">‚úì Selecionar Todos Pendentes</button>
<button class="btn btn-warning" onclick="clearSelection()">‚úó Limpar Sele√ß√£o</button>
</div>
<table>
<thead>
<tr>
<th><input type="checkbox" id="selectAllFinancial" onchange="toggleAllFinancial()"></th>
<th>Paciente</th>
<th>Data</th>
<th>Servi√ßo</th>
<th>Valor</th>
<th>Status</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="financialTable"></tbody>
</table>
</div>

<!-- FLUXO DE CAIXA -->
<div id="fluxo" class="section">
<h2>üìä Fluxo de Caixa</h2>
<div class="form-group" style="max-width:300px"><label>M√™s/Ano</label><input type="month" id="cashFlowMonth" onchange="renderCashFlow()"></div>
<div class="summary-cards">
<div class="summary-card green"><h3 id="cfEntries">R$ 0,00</h3><p>Entradas</p></div>
<div class="summary-card red"><h3 id="cfExits">R$ 0,00</h3><p>Sa√≠das</p></div>
<div class="summary-card blue"><h3 id="cfBalance">R$ 0,00</h3><p>Saldo</p></div>
</div>
<div class="tabs">
<button class="tab active" onclick="showCashFlowTab('entries')">üí∞ Entradas</button>
<button class="tab" onclick="showCashFlowTab('exits')">üí∏ Despesas</button>
</div>
<div id="cfEntriesTab" class="tab-content active">
<table><thead><tr><th>Data</th><th>Paciente</th><th>Servi√ßo</th><th>Valor</th></tr></thead><tbody id="entriesTable"></tbody></table>
</div>
<div id="cfExitsTab" class="tab-content">
<table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="exitsTable"></tbody></table>
</div>
</div>

<!-- RELAT√ìRIOS -->
<div id="relatorios" class="section">
<h2>üìà Relat√≥rios</h2>
<div class="form-group" style="max-width:300px"><label>M√™s/Ano</label><input type="month" id="reportMonth" onchange="renderReports()"></div>
<div class="summary-cards">
<div class="summary-card blue"><h3 id="reportSessions">0</h3><p>Atendimentos</p></div>
<div class="summary-card green"><h3 id="reportRevenue">R$ 0,00</h3><p>Faturamento</p></div>
</div>
<table><thead><tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr></thead>
<tbody id="reportTable"></tbody>
</table>
</div>

</div>

<!-- MODAL DE AGENDAMENTO - APENAS AVALIA√á√ÉO E CONSULTA -->
<div class="modal" id="appointmentModal">
<div class="modal-content">
<div class="modal-header"><h3>Agendamento</h3><button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button></div>
<div class="form-group"><label>Paciente *</label><select id="apptPatient"></select></div>
<div class="form-group"><label>Data *</label><input type="date" id="apptDate"></div>
<div class="form-group"><label>Hor√°rio *</label><input type="time" id="apptTime"></div>
<div class="form-group"><label>Tipo de Atendimento</label>
<select id="apptType">
<option value="consulta">Consulta</option>
<option value="avaliacao">Avalia√ß√£o</option>
</select>
</div>
<div class="form-group"><label>Valor (R$)</label><input type="number" id="apptValue" step="0.01" placeholder="0,00"></div>
<div class="form-group"><label>Observa√ß√µes</label><textarea id="apptNotes" rows="3"></textarea></div>
<div style="display:flex;gap:10px;flex-wrap:wrap">
<button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendAppointmentWhatsApp()" style="display:none">üì± WhatsApp</button>
<button class="btn btn-warning" id="btnToggleCancel" onclick="toggleCancelAppointment()" style="display:none">‚ùå Cancelar</button>
<button class="btn btn-primary" onclick="saveAppointment()" style="margin-left:auto">üíæ Salvar</button>
</div>
</div>
</div>

<!-- MODAL DE PACIENTE -->
<div class="modal" id="patientModal">
<div class="modal-content" style="max-width:700px">
<div class="modal-header"><h3 id="patientModalTitle">Novo Paciente</h3><button class="close-btn" onclick="closeModal('patientModal')">&times;</button></div>

<!-- BOT√ïES DE ABAS COM EMOJIS -->
<div class="patient-tabs">
<button class="patient-tab-btn active" onclick="showPatientTab('info')" id="btnTabInfo">
<span class="emoji">üë§</span>
<span class="label">Informa√ß√µes</span>
</button>
<button class="patient-tab-btn" onclick="showPatientTab('financeiro')" id="btnTabFinanceiro">
<span class="emoji">üí∞</span>
<span class="label">Financeiro</span>
</button>
<button class="patient-tab-btn" onclick="showPatientTab('evolucao')" id="btnTabEvolucao">
<span class="emoji">üìã</span>
<span class="label">Evolu√ß√£o</span>
</button>
<button class="patient-tab-btn" onclick="showPatientTab('relatorio')" id="btnTabRelatorio">
<span class="emoji">üìÑ</span>
<span class="label">Relat√≥rio</span>
</button>
</div>

<div id="tabInfo" class="tab-content active">
<input type="hidden" id="patientId">
<div class="form-group"><label>Nome Completo *</label><input type="text" id="patientName"></div>
<div class="form-group"><label>Telefone *</label><input type="tel" id="patientPhone" placeholder="(00) 00000-0000"></div>
<div class="form-group"><label>E-mail</label><input type="email" id="patientEmail" placeholder="opcional"></div>
<div class="form-group"><label>Valor Padr√£o da Consulta (R$)</label><input type="number" id="patientValue" step="0.01" placeholder="0,00"></div>
<div class="form-group"><label>Queixa Principal / Motivo da Consulta</label><textarea id="patientComplaint" rows="3" placeholder="Descreva a queixa principal..."></textarea></div>
</div>

<div id="tabFinanceiro" class="tab-content">
<div class="summary-cards">
<div class="summary-card green"><h3 id="patientPaid">R$ 0,00</h3><p>Pago</p></div>
<div class="summary-card red"><h3 id="patientPending">R$ 0,00</h3><p>Pendente</p></div>
</div>
<div style="margin-bottom:15px">
<button class="btn btn-whatsapp" onclick="sendPendingSessionsWhatsApp()">üì± Cobrar Selecionadas</button>
</div>
<table>
<thead>
<tr>
<th><input type="checkbox" id="selectAllSessions" onchange="toggleAllSessions()"></th>
<th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th><th>A√ß√µes</th>
</tr>
</thead>
<tbody id="patientFinanceTable"></tbody>
</table>
</div>

<div id="tabEvolucao" class="tab-content">
<div class="form-group">
<label>Nova Evolu√ß√£o / Anota√ß√£o</label>
<textarea id="newEvolution" rows="4" placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>
<button class="btn btn-primary" onclick="addEvolution()" style="margin-top:10px">üíæ Salvar Evolu√ß√£o</button>
</div>
<div id="evolutionsList"></div>
</div>

<div id="tabRelatorio" class="tab-content">
<div class="form-group"><label>M√™s/Ano do Relat√≥rio</label><input type="month" id="reportMonthPatient"></div>
<button class="btn btn-primary" onclick="generatePatientReport()">üìÑ Gerar Relat√≥rio</button>
<div id="reportContainer" style="display:none;margin-top:20px">
<div class="report-box" id="reportContent"></div>
<div style="display:flex;gap:10px;margin-top:15px;flex-wrap:wrap">
<button class="btn btn-primary" onclick="copyReport()">üìã Copiar Texto</button>
<button class="btn btn-whatsapp" onclick="sendReportWhatsApp()">üì± WhatsApp</button>
<button class="btn btn-pdf" onclick="generatePDFReport()">üìï Gerar PDF</button>
</div>
</div>
</div>

<div style="display:flex;justify-content:space-between;margin-top:20px;padding-top:20px;border-top:2px solid #e2e8f0">
<button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()">üóë Excluir Paciente</button>
<button class="btn btn-primary" onclick="savePatient()">üíæ Salvar Paciente</button>
</div>
</div>
</div>

<!-- MODAL DE DESPESA -->
<div class="modal" id="expenseModal">
<div class="modal-content">
<div class="modal-header"><h3>Nova Despesa</h3><button class="close-btn" onclick="closeModal('expenseModal')">&times;</button></div>
<div class="form-group"><label>Data *</label><input type="date" id="expenseDate"></div>
<div class="form-group"><label>Descri√ß√£o *</label><input type="text" id="expenseDesc" placeholder="Ex: Material de escrit√≥rio"></div>
<div class="form-group"><label>Categoria</label><select id="expenseCategory"><option value="material">Material</option><option value="aluguel">Aluguel</option><option value="servicos">Servi√ßos</option><option value="outros">Outros</option></select></div>
<div class="form-group"><label>Valor (R$) *</label><input type="number" id="expenseValue" step="0.01" placeholder="0,00"></div>
<button class="btn btn-primary" onclick="saveExpense()">üíæ Salvar Despesa</button>
</div>
</div>

<div class="footer">
<p><strong>ASM Gest√£o Cl√≠nica</strong></p>
<p>¬© 2024 Dra. Andresa Augusto - Todos os direitos reservados</p>
<p>Proibida reprodu√ß√£o sem autoriza√ß√£o</p>
</div>
</div>

<script>
// ============================================
// CONFIGURA√á√ÉO DO FIREBASE
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyDAP8Krf1QYRUf2VmgeGRXL6eoceVcDnp4",
  authDomain: "asm-gestao-clinica.firebaseapp.com",
  databaseURL: "https://asm-gestao-clinica-default-rtdb.firebaseio.com",
  projectId: "asm-gestao-clinica",
  storageBucket: "asm-gestao-clinica.firebasestorage.app",
  messagingSenderId: "846179775289",
  appId: "1:846179775289:web:b914c4e024b1fb13a66ee8"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ============================================
// VARI√ÅVEIS GLOBAIS
// ============================================
let currentUserCPF = '';
let currentActivationCode = '';
let userDataPath = '';
let config = {};
let patients = [];
let appointments = [];
let evolutions = [];
let expenses = [];
let currentDate = new Date();
let currentPatientId = null;
let currentApptId = null;
let currentReport = '';
let selectedSessions = new Set();
let selectedFinancial = new Set();

// ============================================
// CONFIGURA√á√ïES DE PROFISS√ïES
// ============================================
const professionConfig = {
  fisioterapia: { name: 'Fisioterapia', registry: 'CREFITO', placeholder: '00 0000 F' },
  medicina: { name: 'Medicina', registry: 'CRM', placeholder: '00 0000' },
  nutricao: { name: 'Nutri√ß√£o', registry: 'CRN', placeholder: '00 0000' },
  psicologia: { name: 'Psicologia', registry: 'CRP', placeholder: '00 0000' },
  psicopedagogia: { name: 'Psicopedagogia', registry: 'CRP/CREFITO', placeholder: '00 0000' },
  fonoaudiologia: { name: 'Fonoaudiologia', registry: 'CREFONO', placeholder: '00 0000 F' },
  terapia_ocupacional: { name: 'Terapia Ocupacional', registry: 'CREFITO', placeholder: '00 0000 TO' },
  estetica: { name: 'Est√©tica', registry: 'COREN/CREFITO', placeholder: '00 0000' },
  enfermagem: { name: 'Enfermagem', registry: 'COREN', placeholder: '00 0000' },
  odontologia: { name: 'Odontologia', registry: 'CRO', placeholder: '00 0000' },
  educacao_fisica: { name: 'Educa√ß√£o F√≠sica', registry: 'CREF', placeholder: '00 0000' }
};

// ============================================
// INICIALIZA√á√ÉO
// ============================================
window.onload = function() {
  const savedCPF = localStorage.getItem('asm_user_cpf');
  const savedCode = localStorage.getItem('asm_activation_code');
  
  if (savedCPF && savedCode) {
    currentUserCPF = savedCPF;
    currentActivationCode = savedCode;
    userDataPath = 'users/' + currentUserCPF.replace(/\D/g, '');
    loadDataFromFirebase();
  } else {
    document.getElementById('activationScreen').style.display = 'flex';
    document.getElementById('mainSystem').style.display = 'none';
  }
};

// ============================================
// ATIVA√á√ÉO DO SISTEMA (CPF + C√ìDIGO)
// ============================================
function formatCPF(cpf) {
  cpf = cpf.replace(/\D/g, '');
  if (cpf.length <= 11) {
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  }
  return cpf;
}

document.getElementById('userCPF').addEventListener('input', function(e) {
  e.target.value = formatCPF(e.target.value);
});

async function activateSystem() {
  const cpf = document.getElementById('userCPF').value.trim();
  const code = document.getElementById('activationCode').value.toUpperCase().trim();
  const errorMsg = document.getElementById('activationError');
  const successMsg = document.getElementById('activationSuccess');
  const loading = document.getElementById('activationLoading');
  const btn = document.getElementById('activateBtn');
  
  errorMsg.style.display = 'none';
  successMsg.style.display = 'none';
  
  const cpfNumbers = cpf.replace(/\D/g, '');
  if (cpfNumbers.length !== 11) {
    errorMsg.textContent = 'CPF inv√°lido! Digite os 11 n√∫meros.';
    errorMsg.style.display = 'block';
    return;
  }
  
  if (!code || code.length < 8 || !code.startsWith('AA')) {
    errorMsg.textContent = 'C√≥digo inv√°lido! Use o formato AA000000';
    errorMsg.style.display = 'block';
    return;
  }
  
  loading.style.display = 'block';
  btn.disabled = true;
  
  try {
    const codeRef = database.ref('activationCodes/' + code);
    const snapshot = await codeRef.once('value');
    
    if (!snapshot.exists()) {
      errorMsg.textContent = 'C√≥digo de ativa√ß√£o n√£o encontrado no sistema!';
      errorMsg.style.display = 'block';
    } else {
      const codeData = snapshot.val();
      
      if (codeData.used) {
        if (codeData.cpf === cpfNumbers) {
          currentUserCPF = cpf;
          currentActivationCode = code;
          userDataPath = 'users/' + cpfNumbers;
          
          localStorage.setItem('asm_user_cpf', cpf);
          localStorage.setItem('asm_activation_code', code);
          
          successMsg.style.display = 'block';
          setTimeout(() => {
            loadDataFromFirebase();
          }, 1000);
        } else {
          errorMsg.textContent = 'Este c√≥digo j√° foi utilizado por outro CPF!';
          errorMsg.style.display = 'block';
        }
      } else {
        await codeRef.update({
          used: true,
          cpf: cpfNumbers,
          activatedAt: new Date().toISOString()
        });
        
        currentUserCPF = cpf;
        currentActivationCode = code;
        userDataPath = 'users/' + cpfNumbers;
        
        localStorage.setItem('asm_user_cpf', cpf);
        localStorage.setItem('asm_activation_code', code);
        
        successMsg.style.display = 'block';
        setTimeout(() => {
          loadDataFromFirebase();
        }, 1000);
      }
    }
  } catch (error) {
    console.error('Erro:', error);
    errorMsg.textContent = 'Erro de conex√£o: ' + error.message;
    errorMsg.style.display = 'block';
  } finally {
    loading.style.display = 'none';
    btn.disabled = false;
  }
}

// ============================================
// CARREGAR E SALVAR DADOS NO FIREBASE
// ============================================
async function loadDataFromFirebase() {
  try {
    const snapshot = await database.ref(userDataPath).once('value');
    const data = snapshot.val() || {};
    
    // Se n√£o tiver dados, cria estrutura vazia
    config = data.config || {};
    patients = data.patients || [];
    appointments = data.appointments || [];
    evolutions = data.evolutions || [];
    expenses = data.expenses || [];
    
    showMainSystem();
  } catch (error) {
    console.error('Erro ao carregar dados:', error);
    // Em vez de dar erro, cria dados vazios e permite entrar
    config = {};
    patients = [];
    appointments = [];
    evolutions = [];
    expenses = [];
    showMainSystem();
  }
}

async function saveDataToFirebase() {
  try {
    const data = {
      config: config,
      patients: patients,
      appointments: appointments,
      evolutions: evolutions,
      expenses: expenses,
      lastUpdate: new Date().toISOString()
    };
    
    await database.ref(userDataPath).set(data);
    return true;
  } catch (error) {
    console.error('Erro ao salvar:', error);
    alert('Erro ao salvar dados. Verifique sua conex√£o.');
    return false;
  }
}

// ============================================
// SISTEMA PRINCIPAL
// ============================================
function showMainSystem() {
  document.getElementById('activationScreen').style.display = 'none';
  document.getElementById('mainSystem').style.display = 'block';
  
  document.getElementById('currentUserCPF').textContent = currentUserCPF;
  document.getElementById('displayCPF').textContent = currentUserCPF;
  document.getElementById('displayCode').textContent = currentActivationCode;
  
  initializeApp();
}

function logout() {
  localStorage.removeItem('asm_user_cpf');
  localStorage.removeItem('asm_activation_code');
  location.reload();
}

async function initializeApp() {
  loadConfig();
  renderCalendar();
  renderPatients();
  updateFinancialSummary();
  loadPatientSelect();
  
  const today = new Date().toISOString().slice(0, 7);
  document.getElementById('cashFlowMonth').value = today;
  document.getElementById('reportMonth').value = today;
  
  document.getElementById('currentUserName').textContent = config.professionalName || 'Profissional';
  updateUserBarRegistry();
}

// ============================================
// CONFIGURA√á√ïES
// ============================================
function updateRegistryLabel() {
  const profession = document.getElementById('configProfession').value;
  const label = document.getElementById('registryLabel');
  const input = document.getElementById('configRegistry');
  
  if (profession && professionConfig[profession]) {
    const prof = professionConfig[profession];
    label.textContent = prof.registry + ' *';
    input.placeholder = prof.placeholder;
  } else {
    label.textContent = 'Registro Profissional *';
    input.placeholder = '00000';
  }
}

function loadConfig() {
  document.getElementById('configProfession').value = config.profession || '';
  document.getElementById('configName').value = config.professionalName || '';
  document.getElementById('configRegistry').value = config.registry || '';
  document.getElementById('configClinic').value = config.clinicName || '';
  document.getElementById('configPix').value = config.pix || '';
  updateRegistryLabel();
  updateHeader();
}

async function saveConfig() {
  const profession = document.getElementById('configProfession').value;
  
  if (!profession) {
    alert('Selecione sua profiss√£o!');
    return;
  }
  
  config.profession = profession;
  config.professionalName = document.getElementById('configName').value.trim();
  config.registry = document.getElementById('configRegistry').value.trim();
  config.clinicName = document.getElementById('configClinic').value.trim() || 'ASM Sa√∫de';
  config.pix = document.getElementById('configPix').value.trim();
  
  if (!config.professionalName || !config.registry) {
    alert('Preencha nome e registro profissional!');
    return;
  }
  
  await saveDataToFirebase();
  updateHeader();
  updateUserBarRegistry();
  document.getElementById('currentUserName').textContent = config.professionalName;
  alert('Configura√ß√µes salvas com sucesso!');
}

function updateUserBarRegistry() {
  const registryText = document.getElementById('currentUserRegistry');
  if (config.profession && professionConfig[config.profession]) {
    const prof = professionConfig[config.profession];
    registryText.textContent = prof.registry + ' ' + (config.registry || '---');
  } else {
    registryText.textContent = config.registry || '---';
  }
}

function updateHeader() {
  const subtitle = document.getElementById('headerSubtitle');
  if (config.profession && professionConfig[config.profession]) {
    const profName = professionConfig[config.profession].name;
    subtitle.textContent = (config.professionalName ? config.professionalName + ' - ' : '') + profName;
  } else {
    subtitle.textContent = config.professionalName ? 
      config.professionalName + ' - ' + (config.registry || '') : 
      'Configure seus dados nas Configura√ß√µes';
  }
}

function getProfessionalSignature() {
  let registryLabel = 'Registro';
  if (config.profession && professionConfig[config.profession]) {
    registryLabel = professionConfig[config.profession].registry;
  }
  
  return {
    name: config.professionalName || 'Profissional',
    registry: config.registry ? registryLabel + ' ' + config.registry : '',
    clinic: config.clinicName || 'ASM Sa√∫de',
    pix: config.pix || ''
  };
}

// ============================================
// NAVEGA√á√ÉO
// ============================================
function showSection(section) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
  document.getElementById(section).classList.add('active');
  event.target.classList.add('active');
  
  if (section === 'financeiro') {
    selectedFinancial.clear();
    renderFinancialTable();
  }
  if (section === 'fluxo') renderCashFlow();
  if (section === 'relatorios') renderReports();
}

// ============================================
// AGENDA
// ============================================
function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  document.getElementById('currentMonth').textContent = new Date(year, month).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';
  
  const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
  days.forEach(day => {
    const div = document.createElement('div');
    div.className = 'calendar-header';
    div.textContent = day;
    calendar.appendChild(div);
  });
  
  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement('div'));
  }
  
  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const div = document.createElement('div');
    div.className = 'calendar-day';
    div.innerHTML = '<strong>' + day + '</strong>';
    
    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
      div.style.background = '#1e3a5f';
      div.style.color = 'white';
    }
    
    const dayAppointments = appointments.filter(a => {
      const parts = a.date.split('-');
      return parseInt(parts[0]) === year && (parseInt(parts[1]) - 1) === month && parseInt(parts[2]) === day;
    });
    
    dayAppointments.forEach(appt => {
      const patient = patients.find(p => p.id === appt.patientId);
      const apptDiv = document.createElement('div');
      apptDiv.className = 'appointment' + (appt.cancelled ? ' cancelled' : '');
      apptDiv.innerHTML = '<span>' + appt.time + ' ' + (patient ? patient.name.split(' ')[0] : '') + '</span>';
      const actions = document.createElement('div');
      actions.innerHTML = '<button onclick="event.stopPropagation();editAppointment(\'' + appt.id + '\')" style="background:none;border:none;color:white;cursor:pointer">‚úé</button> <button onclick="event.stopPropagation();toggleCancelAppointmentDirect(\'' + appt.id + '\')" style="background:none;border:none;color:white;cursor:pointer">' + (appt.cancelled ? '‚Ü©' : '‚úï') + '</button>';
      apptDiv.appendChild(actions);
      div.appendChild(apptDiv);
    });
    
    div.onclick = () => openAppointmentModal(year, month, day);
    calendar.appendChild(div);
  }
}

function changeMonth(delta) {
  currentDate.setMonth(currentDate.getMonth() + delta);
  renderCalendar();
}

function openAppointmentModal(year, month, day) {
  currentApptId = null;
  document.getElementById('apptPatient').value = '';
  document.getElementById('apptTime').value = '';
  document.getElementById('apptValue').value = '';
  document.getElementById('apptNotes').value = '';
  document.getElementById('btnWhatsAppt').style.display = 'none';
  document.getElementById('btnToggleCancel').style.display = 'none';
  
  if (year !== undefined) {
    document.getElementById('apptDate').value = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
  } else {
    document.getElementById('apptDate').value = new Date().toISOString().split('T')[0];
  }
  
  document.getElementById('appointmentModal').classList.add('active');
}

function editAppointment(id) {
  const appt = appointments.find(a => a.id === id);
  currentApptId = id;
  document.getElementById('apptPatient').value = appt.patientId;
  document.getElementById('apptDate').value = appt.date;
  document.getElementById('apptTime').value = appt.time;
  document.getElementById('apptType').value = appt.type;
  document.getElementById('apptValue').value = appt.value;
  document.getElementById('apptNotes').value = appt.notes || '';
  document.getElementById('btnWhatsAppt').style.display = 'inline-block';
  document.getElementById('btnToggleCancel').style.display = 'inline-block';
  
  const btnCancel = document.getElementById('btnToggleCancel');
  if (appt.cancelled) {
    btnCancel.textContent = '‚Ü© Reativar';
    btnCancel.className = 'btn btn-success';
  } else {
    btnCancel.textContent = '‚ùå Cancelar';
    btnCancel.className = 'btn btn-warning';
  }
  
  document.getElementById('appointmentModal').classList.add('active');
}

async function saveAppointment() {
  const patientId = document.getElementById('apptPatient').value;
  if (!patientId) {
    alert('Selecione um paciente!');
    return;
  }
  
  const patient = patients.find(p => p.id === patientId);
  const data = {
    id: currentApptId || Date.now().toString(),
    patientId: patientId,
    date: document.getElementById('apptDate').value,
    time: document.getElementById('apptTime').value,
    type: document.getElementById('apptType').value,
    value: document.getElementById('apptValue').value || patient.defaultValue || 0,
    notes: document.getElementById('apptNotes').value,
    paid: currentApptId ? appointments.find(a => a.id === currentApptId).paid : false,
    cancelled: currentApptId ? appointments.find(a => a.id === currentApptId).cancelled : false
  };
  
  if (currentApptId) {
    const idx = appointments.findIndex(a => a.id === currentApptId);
    appointments[idx] = data;
  } else {
    appointments.push(data);
  }
  
  await saveDataToFirebase();
  closeModal('appointmentModal');
  renderCalendar();
  updateFinancialSummary();
}

function toggleCancelAppointment() {
  if (!currentApptId) return;
  toggleCancelAppointmentDirect(currentApptId);
  closeModal('appointmentModal');
}

async function toggleCancelAppointmentDirect(id) {
  const appt = appointments.find(a => a.id === id);
  appt.cancelled = !appt.cancelled;
  await saveDataToFirebase();
  renderCalendar();
  updateFinancialSummary();
}

function sendAppointmentWhatsApp() {
  if (!currentApptId) return;
  const appt = appointments.find(a => a.id === currentApptId);
  const patient = patients.find(p => p.id === appt.patientId);
  const sig = getProfessionalSignature();
  
  let msg = 'Ol√° ' + patient.name + ', tudo bem? üòä\n\nConfirma√ß√£o de agendamento:\n\nüìÖ Data: ' + formatDate(appt.date) + '\n‚è∞ Hor√°rio: ' + appt.time + '\nüè• Local: ' + sig.clinic + '\n\n';
  
  if (!appt.cancelled) {
    msg += 'Estamos te aguardando!' + (sig.name ? '\nAtenciosamente, ' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
  } else {
    msg += '‚ö†Ô∏è ATEN√á√ÉO: Agendamento CANCELADO.';
  }
  
  window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
}

function loadPatientSelect() {
  const select = document.getElementById('apptPatient');
  select.innerHTML = '<option value="">Selecione...</option>';
  patients.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name;
    select.appendChild(opt);
  });
}

// ============================================
// PACIENTES
// ============================================
function renderPatients() {
  const list = document.getElementById('patientsList');
  list.innerHTML = '';
  
  patients.forEach(p => {
    const patientAppts = appointments.filter(a => a.patientId === p.id && !a.cancelled);
    const pending = patientAppts.filter(a => !a.paid).length;
    
    const card = document.createElement('div');
    card.className = 'card';
    let html = '<h3>' + p.name + '</h3><p>üì± ' + p.phone + '</p>';
    if (p.defaultValue) html += '<p>üí∞ R$ ' + parseFloat(p.defaultValue).toFixed(2) + '</p>';
    if (pending > 0) html += '<p style="color:#e53e3e">‚ö†Ô∏è ' + pending + ' pendente(s)</p>';
    
    card.innerHTML = html;
    card.onclick = () => openPatientModal(p.id);
    list.appendChild(card);
  });
}

function searchPatients(term) {
  document.querySelectorAll('#patientsList .card').forEach(card => {
    card.style.display = card.querySelector('h3').textContent.toLowerCase().includes(term.toLowerCase()) ? 'block' : 'none';
  });
}

function openPatientModal(patientId) {
  currentPatientId = patientId;
  selectedSessions.clear();
  document.getElementById('patientId').value = '';
  document.getElementById('patientName').value = '';
  document.getElementById('patientPhone').value = '';
  document.getElementById('patientEmail').value = '';
  document.getElementById('patientValue').value = '';
  document.getElementById('patientComplaint').value = '';
  showPatientTab('info');
  
  if (patientId) {
    const p = patients.find(x => x.id === patientId);
    document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
    document.getElementById('patientId').value = p.id;
    document.getElementById('patientName').value = p.name;
    document.getElementById('patientPhone').value = p.phone;
    document.getElementById('patientEmail').value = p.email || '';
    document.getElementById('patientValue').value = p.defaultValue || '';
    document.getElementById('patientComplaint').value = p.complaint || '';
    document.getElementById('btnDeletePatient').style.display = 'block';
    renderPatientFinance();
    renderEvolutions();
  } else {
    document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
    document.getElementById('btnDeletePatient').style.display = 'none';
  }
  
  document.getElementById('patientModal').classList.add('active');
}

async function savePatient() {
  const id = document.getElementById('patientId').value;
  const data = {
    id: id || Date.now().toString(),
    name: document.getElementById('patientName').value.trim(),
    phone: document.getElementById('patientPhone').value.trim(),
    email: document.getElementById('patientEmail').value.trim(),
    defaultValue: document.getElementById('patientValue').value,
    complaint: document.getElementById('patientComplaint').value.trim()
  };
  
  if (!data.name || !data.phone) {
    alert('Preencha nome e telefone!');
    return;
  }
  
  if (id) {
    const idx = patients.findIndex(p => p.id === id);
    patients[idx] = data;
  } else {
    patients.push(data);
  }
  
  await saveDataToFirebase();
  closeModal('patientModal');
  renderPatients();
  loadPatientSelect();
}

async function deletePatient() {
  if (!confirm('Tem certeza que deseja excluir este paciente e todos os seus dados?')) return;
  
  patients = patients.filter(p => p.id !== currentPatientId);
  appointments = appointments.filter(a => a.patientId !== currentPatientId);
  evolutions = evolutions.filter(e => e.patientId !== currentPatientId);
  
  await saveDataToFirebase();
  closeModal('patientModal');
  renderPatients();
  renderCalendar();
  updateFinancialSummary();
}

// ============================================
// ABAS DO PACIENTE COM BOT√ïES
// ============================================
function showPatientTab(tab) {
  // Remove active de todos os bot√µes
  document.querySelectorAll('.patient-tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('#patientModal .tab-content').forEach(t => t.classList.remove('active'));
  
  // Adiciona active no bot√£o clicado
  document.getElementById('btnTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  
  if (tab === 'financeiro') renderPatientFinance();
  if (tab === 'evolucao') renderEvolutions();
}

function renderPatientFinance() {
  const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled);
  const paid = patientAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  const pending = patientAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  
  document.getElementById('patientPaid').textContent = 'R$ ' + paid.toFixed(2);
  document.getElementById('patientPending').textContent = 'R$ ' + pending.toFixed(2);
  
  const tbody = document.getElementById('patientFinanceTable');
  tbody.innerHTML = '';
  
  patientAppts.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
    const row = document.createElement('tr');
    row.className = 'session-row' + (selectedSessions.has(appt.id) ? ' selected' : '');
    row.onclick = (e) => {
      if (e.target.type !== 'checkbox') toggleSessionSelection(appt.id);
    };
    row.innerHTML = '<td><input type="checkbox" class="session-checkbox" ' + (selectedSessions.has(appt.id) ? 'checked' : '') + ' onchange="toggleSessionSelection(\'' + appt.id + '\')"></td><td>' + formatDate(appt.date) + '</td><td>' + appt.type + '</td><td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td><td>' + (appt.paid ? 'Pago' : 'Pendente') + '</td><td><button class="btn btn-primary" onclick="togglePayment(\'' + appt.id + '\')">' + (appt.paid ? 'Desmarcar' : 'Pagar') + '</button></td>';
    tbody.appendChild(row);
  });
}

function toggleSessionSelection(apptId) {
  if (selectedSessions.has(apptId)) selectedSessions.delete(apptId);
  else selectedSessions.add(apptId);
  renderPatientFinance();
}

function toggleAllSessions() {
  const patientAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && !a.paid);
  const allSelected = patientAppts.every(a => selectedSessions.has(a.id));
  patientAppts.forEach(a => allSelected ? selectedSessions.delete(a.id) : selectedSessions.add(a.id));
  renderPatientFinance();
  document.getElementById('selectAllSessions').checked = !allSelected;
}

function sendPendingSessionsWhatsApp() {
  if (selectedSessions.size === 0) {
    alert('Selecione pelo menos uma sess√£o!');
    return;
  }
  
  const patient = patients.find(p => p.id === currentPatientId);
  const sig = getProfessionalSignature();
  let total = 0, sessionsList = '';
  
  const selectedAppts = appointments.filter(a => selectedSessions.has(a.id)).sort((a, b) => new Date(a.date) - new Date(b.date));
  selectedAppts.forEach((appt, index) => {
    total += parseFloat(appt.value || 0);
    sessionsList += (index + 1) + '. ' + formatDate(appt.date) + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2) + '\n';
  });
  
  let msg = 'Ol√° ' + patient.name + ', tudo bem? üòä\n\nAtendimentos em aberto:\n\n' + sessionsList + '\nüí∞ *Total: R$ ' + total.toFixed(2) + '*\n\n';
  if (sig.pix) msg += 'üí≥ Chave Pix:\n*' + sig.pix + '*\n\n';
  msg += 'Qualquer d√∫vida, estou √† disposi√ß√£o!' + (sig.name ? '\n\nAtenciosamente,\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
  
  window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
}

function renderEvolutions() {
  const list = document.getElementById('evolutionsList');
  list.innerHTML = '';
  
  evolutions.filter(e => e.patientId === currentPatientId).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time)).forEach(evo => {
    const div = document.createElement('div');
    div.style.cssText = 'background:#f7fafc;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #1e3a5f';
    div.innerHTML = '<small style="color:#718096">' + formatDate(evo.date) + ' √†s ' + evo.time + '</small><p style="margin-top:5px">' + evo.text + '</p>';
    list.appendChild(div);
  });
}

async function addEvolution() {
  const text = document.getElementById('newEvolution').value;
  if (!text.trim()) return;
  
  const now = new Date();
  evolutions.push({
    id: Date.now().toString(),
    patientId: currentPatientId,
    date: now.toISOString().split('T')[0],
    time: now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}),
    text: text
  });
  
  await saveDataToFirebase();
  document.getElementById('newEvolution').value = '';
  renderEvolutions();
}

// ============================================
// RELAT√ìRIO DO PACIENTE COM PDF
// ============================================
function generatePatientReport() {
  const month = document.getElementById('reportMonthPatient').value;
  if (!month) {
    alert('Selecione o m√™s!');
    return;
  }
  
  const sig = getProfessionalSignature();
  const [year, mon] = month.split('-').map(Number);
  const patient = patients.find(p => p.id === currentPatientId);
  const monthEvos = evolutions.filter(e => e.patientId === currentPatientId && e.date.startsWith(month)).sort((a, b) => new Date(a.date) - new Date(b.date));
  const monthAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && a.date.startsWith(month));
  const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
  
  let report = 'RELAT√ìRIO MENSAL - ' + sig.clinic.toUpperCase() + '\n';
  report += (sig.name ? sig.name + '\n' : '');
  report += (sig.registry ? sig.registry + '\n' : '');
  report += '================================\n\n';
  report += 'Paciente: ' + patient.name + '\n';
  report += 'Per√≠odo: ' + monthName + '\n\n';
  report += 'üìã RESUMO\n';
  report += 'Atendimentos: ' + monthAppts.length + '\n\n';
  
  if (monthAppts.length > 0) {
    report += 'Datas:\n';
    monthAppts.forEach(a => {
      report += '‚Ä¢ ' + formatDate(a.date) + ' - ' + a.time + '\n';
    });
    report += '\n';
  }
  
  report += 'üìä EVOLU√á√ÉO / ANOTA√á√ïES\n\n';
  if (monthEvos.length === 0) {
    report += 'Nenhuma evolu√ß√£o registrada.\n';
  } else {
    monthEvos.forEach((evo, i) => {
      report += 'Atendimento ' + (i + 1) + ' - ' + formatDate(evo.date) + '\n';
      report += evo.text + '\n';
      report += '--------------------------------\n\n';
    });
  }
  
  report += '\n' + sig.clinic + (sig.name ? '\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
  
  currentReport = report;
  document.getElementById('reportContent').textContent = report;
  document.getElementById('reportContainer').style.display = 'block';
}

function copyReport() {
  navigator.clipboard.writeText(currentReport).then(() => alert('Relat√≥rio copiado!'));
}

function sendReportWhatsApp() {
  const patient = patients.find(p => p.id === currentPatientId);
  window.open('https://wa.me/55' + patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(currentReport), '_blank');
}

function generatePDFReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const sig = getProfessionalSignature();
  const patient = patients.find(p => p.id === currentPatientId);
  const month = document.getElementById('reportMonthPatient').value;
  const [year, mon] = month.split('-').map(Number);
  const monthName = new Date(year, mon - 1).toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
  
  doc.setFillColor(30, 58, 95);
  doc.rect(0, 0, 210, 40, 'F');
  
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20);
  doc.text(sig.clinic.toUpperCase(), 105, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.text(sig.name || 'Profissional', 105, 30, { align: 'center' });
  doc.text(sig.registry || '', 105, 37, { align: 'center' });
  
  doc.setDrawColor(30, 58, 95);
  doc.setLineWidth(0.5);
  doc.line(10, 45, 200, 45);
  
  doc.setTextColor(30, 58, 95);
  doc.setFontSize(16);
  doc.text('RELAT√ìRIO MENSAL', 105, 55, { align: 'center' });
  
  doc.setFontSize(11);
  doc.setTextColor(0, 0, 0);
  doc.text('Paciente: ' + patient.name, 10, 70);
  doc.text('Per√≠odo: ' + monthName, 10, 78);
  
  doc.line(10, 85, 200, 85);
  
  const monthEvos = evolutions.filter(e => e.patientId === currentPatientId && e.date.startsWith(month)).sort((a, b) => new Date(a.date) - new Date(b.date));
  const monthAppts = appointments.filter(a => a.patientId === currentPatientId && !a.cancelled && a.date.startsWith(month));
  
  let yPosition = 95;
  
  doc.setFontSize(12);
  doc.setTextColor(30, 58, 95);
  doc.text('RESUMO DO PER√çODO', 10, yPosition);
  yPosition += 10;
  
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(10);
  doc.text('Total de Atendimentos: ' + monthAppts.length, 10, yPosition);
  yPosition += 8;
  
  if (monthAppts.length > 0) {
    doc.text('Datas dos Atendimentos:', 10, yPosition);
    yPosition += 6;
    monthAppts.forEach(a => {
      doc.text('‚Ä¢ ' + formatDate(a.date) + ' √†s ' + a.time, 15, yPosition);
      yPosition += 5;
    });
    yPosition += 5;
  }
  
  if (yPosition > 250) {
    doc.addPage();
    yPosition = 20;
  }
  
  doc.setFontSize(12);
  doc.setTextColor(30, 58, 95);
  doc.text('EVOLU√á√ÉO CL√çNICA', 10, yPosition);
  yPosition += 10;
  
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(10);
  
  if (monthEvos.length === 0) {
    doc.text('Nenhuma evolu√ß√£o registrada neste per√≠odo.', 10, yPosition);
    yPosition += 10;
  } else {
    monthEvos.forEach((evo, i) => {
      if (yPosition > 270) {
        doc.addPage();
        yPosition = 20;
      }
      
      doc.setFont(undefined, 'bold');
      doc.text('Atendimento ' + (i + 1) + ' - ' + formatDate(evo.date), 10, yPosition);
      yPosition += 6;
      
      doc.setFont(undefined, 'normal');
      const splitText = doc.splitTextToSize(evo.text, 180);
      doc.text(splitText, 10, yPosition);
      yPosition += (splitText.length * 5) + 8;
      
      doc.setDrawColor(200, 200, 200);
      doc.line(10, yPosition, 200, yPosition);
      yPosition += 8;
    });
  }
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text('Documento gerado em ' + new Date().toLocaleDateString('pt-BR') + ' - ASM Gest√£o Cl√≠nica', 105, 290, { align: 'center' });
    doc.text('¬© 2024 Dra. Andresa Augusto - Proibida reprodu√ß√£o sem autoriza√ß√£o', 105, 295, { align: 'center' });
  }
  
  doc.save('Relatorio_' + patient.name.replace(/\s+/g, '_') + '_' + month + '.pdf');
}

// ============================================
// FINANCEIRO
// ============================================
function renderFinancialTable() {
  const tbody = document.getElementById('financialTable');
  tbody.innerHTML = '';
  
  const pendingAppts = appointments.filter(a => !a.cancelled && !a.paid).sort((a, b) => new Date(b.date) - new Date(a.date));
  
  pendingAppts.forEach(appt => {
    const patient = patients.find(p => p.id === appt.patientId);
    const row = document.createElement('tr');
    row.className = 'financial-row' + (selectedFinancial.has(appt.id) ? ' selected' : '');
    row.onclick = (e) => {
      if (e.target.type !== 'checkbox') toggleFinancialSelection(appt.id);
    };
    row.innerHTML = '<td><input type="checkbox" class="session-checkbox" ' + (selectedFinancial.has(appt.id) ? 'checked' : '') + ' onchange="toggleFinancialSelection(\'' + appt.id + '\')"></td><td>' + (patient ? patient.name : '-') + '</td><td>' + formatDate(appt.date) + '</td><td>' + (appt.type === 'avaliacao' ? 'Avalia√ß√£o' : 'Consulta') + '</td><td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td><td>‚è≥ Pendente</td><td><button class="btn btn-primary" onclick="event.stopPropagation();togglePayment(\'' + appt.id + '\')">Pagar</button></td>';
    tbody.appendChild(row);
  });
  
  const count = selectedFinancial.size;
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('btnCobrarSelecionados').style.display = count > 0 ? 'inline-block' : 'none';
}

function toggleFinancialSelection(apptId) {
  if (selectedFinancial.has(apptId)) selectedFinancial.delete(apptId);
  else selectedFinancial.add(apptId);
  renderFinancialTable();
}

function toggleAllFinancial() {
  const pendingAppts = appointments.filter(a => !a.cancelled && !a.paid);
  const allSelected = pendingAppts.every(a => selectedFinancial.has(a.id));
  pendingAppts.forEach(a => allSelected ? selectedFinancial.delete(a.id) : selectedFinancial.add(a.id));
  renderFinancialTable();
}

function selectAllPending() {
  const pendingAppts = appointments.filter(a => !a.cancelled && !a.paid);
  pendingAppts.forEach(a => selectedFinancial.add(a.id));
  renderFinancialTable();
}

function clearSelection() {
  selectedFinancial.clear();
  renderFinancialTable();
  document.getElementById('selectAllFinancial').checked = false;
}

function sendSelectedPendingWhatsApp() {
  if (selectedFinancial.size === 0) {
    alert('Selecione pelo menos um atendimento!');
    return;
  }
  
  const byPatient = {};
  let totalGeral = 0;
  
  selectedFinancial.forEach(apptId => {
    const appt = appointments.find(a => a.id === apptId);
    const patient = patients.find(p => p.id === appt.patientId);
    if (!byPatient[appt.patientId]) {
      byPatient[appt.patientId] = {patient: patient, appts: [], total: 0};
    }
    byPatient[appt.patientId].appts.push(appt);
    byPatient[appt.patientId].total += parseFloat(appt.value || 0);
    totalGeral += parseFloat(appt.value || 0);
  });
  
  const sig = getProfessionalSignature();
  
  if (Object.keys(byPatient).length === 1) {
    const pid = Object.keys(byPatient)[0];
    const data = byPatient[pid];
    let msg = 'Ol√° ' + data.patient.name + ', tudo bem? üòä\n\n';
    msg += 'Gostaria de lembrar que voc√™ possui os seguintes atendimentos em aberto:\n\n';
    data.appts.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach((appt, idx) => {
      msg += (idx + 1) + '. ' + formatDate(appt.date) + ' - ' + (appt.type === 'avaliacao' ? 'Avalia√ß√£o' : 'Consulta') + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2) + '\n';
    });
    msg += '\nüí∞ *Total: R$ ' + data.total.toFixed(2) + '*\n\n';
    if (sig.pix) msg += 'üí≥ Chave Pix para pagamento:\n*' + sig.pix + '*\n\n';
    msg += 'Agrade√ßo a aten√ß√£o! Qualquer d√∫vida, estou √† disposi√ß√£o.' + (sig.name ? '\n\nAtenciosamente,\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
    window.open('https://wa.me/55' + data.patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
  } else {
    let msgConfirm = 'Voc√™ selecionou atendimentos de ' + Object.keys(byPatient).length + ' pacientes diferentes:\n\n';
    Object.values(byPatient).forEach((data, idx) => {
      msgConfirm += (idx + 1) + '. ' + data.patient.name + ' - R$ ' + data.total.toFixed(2) + '\n';
    });
    msgConfirm += '\nDeseja enviar mensagem para todos? Ser√° aberta uma janela para cada paciente.';
    
    if (confirm(msgConfirm)) {
      Object.values(byPatient).forEach(data => {
        let msg = 'Ol√° ' + data.patient.name + ', tudo bem? üòä\n\n';
        msg += 'Gostaria de lembrar que voc√™ possui os seguintes atendimentos em aberto:\n\n';
        data.appts.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach((appt, idx) => {
          msg += (idx + 1) + '. ' + formatDate(appt.date) + ' - ' + (appt.type === 'avaliacao' ? 'Avalia√ß√£o' : 'Consulta') + ' - R$ ' + parseFloat(appt.value || 0).toFixed(2) + '\n';
        });
        msg += '\nüí∞ *Total: R$ ' + data.total.toFixed(2) + '*\n\n';
        if (sig.pix) msg += 'üí≥ Chave Pix para pagamento:\n*' + sig.pix + '*\n\n';
        msg += 'Agrade√ßo a aten√ß√£o! Qualquer d√∫vida, estou √† disposi√ß√£o.' + (sig.name ? '\n\nAtenciosamente,\n' + sig.name : '') + (sig.registry ? '\n' + sig.registry : '');
        setTimeout(() => {
          window.open('https://wa.me/55' + data.patient.phone.replace(/\D/g, '') + '?text=' + encodeURIComponent(msg), '_blank');
        }, 500);
      });
    }
  }
}

async function togglePayment(id) {
  const appt = appointments.find(a => a.id === id);
  appt.paid = !appt.paid;
  await saveDataToFirebase();
  renderFinancialTable();
  updateFinancialSummary();
  renderCalendar();
  if (currentPatientId) renderPatientFinance();
}

function updateFinancialSummary() {
  const activeAppts = appointments.filter(a => !a.cancelled);
  const received = activeAppts.filter(a => a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  const pending = activeAppts.filter(a => !a.paid).reduce((s, a) => s + parseFloat(a.value || 0), 0);
  document.getElementById('totalReceived').textContent = 'R$ ' + received.toFixed(2);
  document.getElementById('totalPending').textContent = 'R$ ' + pending.toFixed(2);
  document.getElementById('totalSessions').textContent = activeAppts.length;
}

// ============================================
// FLUXO DE CAIXA
// ============================================
function showCashFlowTab(tab) {
  document.querySelectorAll('#fluxo .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#fluxo .tab-content').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('cf' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
}

function renderCashFlow() {
  const month = document.getElementById('cashFlowMonth').value;
  if (!month) return;
  
  const entries = appointments.filter(a => !a.cancelled && a.paid && a.date.startsWith(month));
  const monthExpenses = expenses.filter(e => e.date.startsWith(month));
  const totalEntries = entries.reduce((s, a) => s + parseFloat(a.value || 0), 0);
  const totalExits = monthExpenses.reduce((s, e) => s + parseFloat(e.value || 0), 0);
  
  document.getElementById('cfEntries').textContent = 'R$ ' + totalEntries.toFixed(2);
  document.getElementById('cfExits').textContent = 'R$ ' + totalExits.toFixed(2);
  document.getElementById('cfBalance').textContent = 'R$ ' + (totalEntries - totalExits).toFixed(2);
  
  const entriesBody = document.getElementById('entriesTable');
  entriesBody.innerHTML = '';
  entries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(appt => {
    const patient = patients.find(p => p.id === appt.patientId);
    const row = document.createElement('tr');
    row.innerHTML = '<td>' + formatDate(appt.date) + '</td><td>' + (patient ? patient.name : '-') + '</td><td>' + (appt.type === 'avaliacao' ? 'Avalia√ß√£o' : 'Consulta') + '</td><td>R$ ' + parseFloat(appt.value || 0).toFixed(2) + '</td>';
    entriesBody.appendChild(row);
  });
  
  const exitsBody = document.getElementById('exitsTable');
  exitsBody.innerHTML = '';
  monthExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(exp => {
    const row = document.createElement('tr');
    row.innerHTML = '<td>' + formatDate(exp.date) + '</td><td>' + exp.description + '</td><td>' + exp.category + '</td><td>R$ ' + parseFloat(exp.value || 0).toFixed(2) + '</td><td><button class="btn btn-danger" onclick="deleteExpense(\'' + exp.id + '\')">üóë</button></td>';
    exitsBody.appendChild(row);
  });
  
  if (!document.getElementById('cfEntriesTab').classList.contains('active') && !document.getElementById('cfExitsTab').classList.contains('active')) {
    showCashFlowTab('entries');
  }
}

async function deleteExpense(id) {
  if (!confirm('Excluir despesa?')) return;
  expenses = expenses.filter(e => e.id !== id);
  await saveDataToFirebase();
  renderCashFlow();
}

function openExpenseModal() {
  document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('expenseDesc').value = '';
  document.getElementById('expenseValue').value = '';
  document.getElementById('expenseModal').classList.add('active');
}

async function saveExpense() {
  const data = {
    id: Date.now().toString(),
    date: document.getElementById('expenseDate').value,
    description: document.getElementById('expenseDesc').value,
    category: document.getElementById('expenseCategory').value,
    value: document.getElementById('expenseValue').value
  };
  
  if (!data.date || !data.description || !data.value) {
    alert('Preencha todos os campos!');
    return;
  }
  
  expenses.push(data);
  await saveDataToFirebase();
  closeModal('expenseModal');
  renderCashFlow();
}

// ============================================
// RELAT√ìRIOS
// ============================================
function renderReports() {
  const month = document.getElementById('reportMonth').value;
  if (!month) return;
  
  const monthAppts = appointments.filter(a => !a.cancelled && a.date.startsWith(month));
  const totalRevenue = monthAppts.reduce((s, a) => s + parseFloat(a.value || 0), 0);
  
  document.getElementById('reportSessions').textContent = monthAppts.length;
  document.getElementById('reportRevenue').textContent = 'R$ ' + totalRevenue.toFixed(2);
  
  const reportBody = document.getElementById('reportTable');
  reportBody.innerHTML = '';
  
  const patientStats = {};
  monthAppts.forEach(appt => {
    if (!patientStats[appt.patientId]) {
      patientStats[appt.patientId] = {sessions: 0, total: 0};
    }
    patientStats[appt.patientId].sessions++;
    patientStats[appt.patientId].total += parseFloat(appt.value || 0);
  });
  
  Object.entries(patientStats).sort((a, b) => b[1].sessions - a[1].sessions).forEach(([patientId, stats]) => {
    const patient = patients.find(p => p.id === patientId);
    const row = document.createElement('tr');
    row.innerHTML = '<td>' + (patient ? patient.name : 'Paciente removido') + '</td><td>' + stats.sessions + '</td><td>R$ ' + stats.total.toFixed(2) + '</td>';
    reportBody.appendChild(row);
  });
}

// ============================================
// UTILIT√ÅRIOS
// ============================================
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function formatDate(dateStr) {
  const parts = dateStr.split('-');
  return parts[2] + '/' + parts[1] + '/' + parts[0];
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('active');
  }
});

document.addEventListener('DOMContentLoaded', function() {
  const fluxoSection = document.getElementById('fluxo');
  const tabs = fluxoSection.querySelector('.tabs');
  const btnExpense = document.createElement('button');
  btnExpense.className = 'btn btn-danger';
  btnExpense.textContent = '+ Despesa';
  btnExpense.style.marginLeft = 'auto';
  btnExpense.onclick = openExpenseModal;
  tabs.appendChild(btnExpense);
});
</script>
</body>
</html>
