<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a5f">
    <title>ASM Gest√£o Cl√≠nica Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDAP8Krf1QYRUf2VmgeGRXL6eoceVcDnp4",
            authDomain: "asm-gestao-clinica.firebaseapp.com",
            projectId: "asm-gestao-clinica",
            storageBucket: "asm-gestao-clinica.firebasestorage.app",
            messagingSenderId: "846179775289",
            appId: "1:846179775289:web:b914c4e024b1fb13a66ee8"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('M√∫ltiplas abas abertas');
            } else if (err.code == 'unimplemented') {
                console.log('Navegador n√£o suporta persist√™ncia');
            }
        });
        
        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
    </script>
    <style>
        :root {
            --azul-marinho: #1e3a5f;
            --dourado: #c9a227;
            --cinza-claro: #f5f5f5;
            --branco: #ffffff;
            --verde: #52b788;
            --vermelho: #e76f51;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--azul-marinho) 0%, #2c4a6e 100%);
            min-height: 100vh;
        }
        
        .activation-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .activation-card {
            background: var(--branco);
            border-radius: 20px;
            padding: 40px 30px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .logo-activation {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--azul-marinho), var(--dourado));
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }
        
        .activation-title {
            color: var(--azul-marinho);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .activation-subtitle {
            color: #666;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .code-hint {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #1e3a5f;
            text-align: left;
        }
        
        .code-input-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .code-input {
            width: 45px;
            height: 55px;
            border: 2px solid #ddd;
            border-radius: 12px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--azul-marinho);
            text-transform: uppercase;
            transition: all 0.3s;
        }
        
        .code-input:focus {
            outline: none;
            border-color: var(--dourado);
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.2);
            transform: scale(1.05);
        }
        
        .btn-activate {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--azul-marinho), #2c4a6e);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-activate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(30, 58, 95, 0.4);
        }
        
        .btn-activate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .plan-info {
            margin-top: 25px;
            padding: 20px;
            background: var(--cinza-claro);
            border-radius: 15px;
            display: none;
            border-left: 4px solid var(--dourado);
            animation: slideIn 0.3s ease;
        }
        
        .plan-info.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .plan-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .plan-basic { background: #cd7f32; color: white; }
        .plan-gold { background: var(--dourado); color: var(--azul-marinho); }
        .plan-premium { background: linear-gradient(135deg, var(--azul-marinho), var(--dourado)); color: white; }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--azul-marinho);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dashboard {
            display: none;
            min-height: 100vh;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .header {
            background: var(--azul-marinho);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .plan-tag {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .main-menu {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            flex-wrap: wrap;
        }
        
        .menu-btn {
            padding: 15px 25px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .menu-btn:hover, .menu-btn.active {
            background: var(--dourado);
            color: var(--azul-marinho);
            transform: translateY(-2px);
        }
        
        .section-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-title {
            color: var(--azul-marinho);
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--dourado);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .doc-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .doc-tab {
            padding: 12px 20px;
            background: var(--cinza-claro);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .doc-tab:hover {
            background: #e0e0e0;
        }
        
        .doc-tab.active {
            background: var(--azul-marinho);
            color: white;
        }
        
        .doc-content {
            display: none;
        }
        
        .doc-content.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--azul-marinho);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--dourado);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: var(--azul-marinho);
            color: white;
        }
        
        .btn-success {
            background: var(--verde);
            color: white;
        }
        
        .btn-danger {
            background: var(--vermelho);
            color: white;
        }
        
        .btn-whatsapp {
            background: #25d366;
            color: white;
        }
        
        .btn-warning {
            background: #f4a261;
            color: white;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: white;
        }
        
        .summary-card.green { background: var(--verde); }
        .summary-card.red { background: var(--vermelho); }
        .summary-card.blue { background: var(--azul-marinho); }
        .summary-card.gold { background: var(--dourado); color: var(--azul-marinho); }
        
        .summary-card h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background: var(--cinza-claro);
            font-weight: 600;
            color: var(--azul-marinho);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            padding: 10px;
            background: var(--azul-marinho);
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .calendar-day {
            background: var(--cinza-claro);
            min-height: 100px;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calendar-day:hover {
            background: #e0e0e0;
        }
        
        .calendar-day.today {
            background: var(--dourado);
            color: var(--azul-marinho);
            font-weight: bold;
        }
        
        .appointment-item {
            background: var(--azul-marinho);
            color: white;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin: 2px 0;
            cursor: pointer;
        }
        
        .appointment-item.cancelled {
            background: #adb5bd;
            text-decoration: line-through;
        }
        
        .signature-area {
            background: white;
            border: 2px dashed var(--azul-marinho);
            border-radius: 10px;
            position: relative;
            margin: 15px 0;
        }
        
        .signature-pad {
            width: 100%;
            height: 150px;
            border-radius: 10px;
            touch-action: none;
            display: block;
        }
        
        .signature-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #999;
            font-size: 0.85rem;
            pointer-events: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .pain-scale {
            background: var(--cinza-claro);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        .pain-numbers {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        
        .pain-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .pain-number.selected {
            background: var(--azul-marinho);
            color: white;
            border-color: var(--azul-marinho);
            transform: scale(1.1);
        }
        
        .pain-number.low.selected { background: #4caf50; border-color: #4caf50; }
        .pain-number.medium.selected { background: #ff9800; border-color: #ff9800; }
        .pain-number.high.selected { background: #f44336; border-color: #f44336; }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 9999;
            font-size: 0.9rem;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .evolution-item {
            background: var(--cinza-claro);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--dourado);
        }
        
        .patient-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .patient-card:hover {
            border-color: var(--azul-marinho);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .activation-card {
                padding: 30px 20px;
            }
            
            .code-input {
                width: 38px;
                height: 48px;
                font-size: 1.2rem;
            }
            
            .main-menu {
                gap: 10px;
                padding: 15px;
            }
            
            .menu-btn {
                padding: 12px 18px;
                font-size: 0.8rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }
        }
    </style>
</head>
<body>

    <!-- TELA DE ATIVA√á√ÉO -->
    <div id="activationScreen" class="activation-screen">
        <div class="activation-card">
            <div class="logo-activation">üè•</div>
            <h1 class="activation-title">ASM Gest√£o Cl√≠nica Pro</h1>
            <p class="activation-subtitle">Sistema Completo para Fisioterapeutas</p>
            
            <div class="code-hint">
                <strong>Formato do c√≥digo:</strong><br>
                ‚Ä¢ <strong>BS</strong> + 6 caracteres = Plano B√°sico (Documentos)<br>
                ‚Ä¢ <strong>GD</strong> + 6 caracteres = Plano Gold (Gest√£o)<br>
                ‚Ä¢ <strong>PM</strong> + 6 caracteres = Plano Premium (Completo)
            </div>
            
            <div class="code-input-group">
                <input type="text" class="code-input" maxlength="1" data-index="0">
                <input type="text" class="code-input" maxlength="1" data-index="1">
                <input type="text" class="code-input" maxlength="1" data-index="2">
                <input type="text" class="code-input" maxlength="1" data-index="3">
                <input type="text" class="code-input" maxlength="1" data-index="4">
                <input type="text" class="code-input" maxlength="1" data-index="5">
                <input type="text" class="code-input" maxlength="1" data-index="6">
                <input type="text" class="code-input" maxlength="1" data-index="7">
            </div>
            
            <button class="btn-activate" id="btnActivate" onclick="activateCode()">
                Ativar Sistema
            </button>
            
            <div id="planInfo" class="plan-info">
                <span id="planBadge" class="plan-badge"></span>
                <h3 id="planTitle" style="color: var(--azul-marinho); margin: 10px 0;"></h3>
                <p id="planDescription" style="color: #666; font-size: 0.9rem;"></p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="dashboard">
        <div class="header">
            <div class="user-info">
                <span id="planTag" class="plan-tag"></span>
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </div>
            <h1>üè• ASM Gest√£o Cl√≠nica Pro</h1>
            <p id="headerSubtitle">Sistema Completo para Fisioterapeutas</p>
        </div>

        <div class="main-menu" id="mainMenu"></div>

        <div class="section-container" id="sectionContainer"></div>
    </div>

    <!-- MODAIS -->
    <div class="modal" id="appointmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agendamento</h3>
                <button class="close-btn" onclick="closeModal('appointmentModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Paciente *</label>
                <select id="apptPatient"></select>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="apptDate">
                </div>
                <div class="form-group">
                    <label>Hor√°rio *</label>
                    <input type="time" id="apptTime">
                </div>
            </div>
            <div class="form-group">
                <label>Tipo</label>
                <select id="apptType">
                    <option value="normal">Normal</option>
                    <option value="laser">Laser</option>
                    <option value="avaliacao">Avalia√ß√£o</option>
                </select>
            </div>
            <div class="form-group">
                <label>Valor (R$)</label>
                <input type="number" id="apptValue" step="0.01">
            </div>
            <div class="form-group">
                <label>Observa√ß√µes</label>
                <textarea id="apptNotes" rows="3"></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-whatsapp" id="btnWhatsAppt" onclick="sendAppointmentWhatsApp()" style="display:none">üì± WhatsApp</button>
                <button class="btn btn-warning" id="btnToggleCancel" onclick="toggleCancelAppointment()" style="display:none">‚ùå Cancelar</button>
                <button class="btn btn-primary" onclick="saveAppointment()" style="margin-left:auto">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="patientModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="patientModalTitle">Novo Paciente</h3>
                <button class="close-btn" onclick="closeModal('patientModal')">&times;</button>
            </div>
            <input type="hidden" id="patientId">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome *</label>
                    <input type="text" id="patientName">
                </div>
                <div class="form-group">
                    <label>Telefone *</label>
                    <input type="tel" id="patientPhone" placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                    <label>E-mail</label>
                    <input type="email" id="patientEmail">
                </div>
                <div class="form-group">
                    <label>Valor Padr√£o</label>
                    <input type="number" id="patientValue" step="0.01">
                </div>
            </div>
            <div class="form-group">
                <label>Queixa Principal</label>
                <textarea id="patientComplaint" rows="3"></textarea>
            </div>
            
            <div id="patientEvolutions" style="margin-top: 20px; display: none;">
                <h4 style="color: var(--azul-marinho); margin-bottom: 15px;">üìà Evolu√ß√µes</h4>
                <div class="form-group">
                    <label>Nova Evolu√ß√£o</label>
                    <textarea id="newEvolution" rows="3" placeholder="Descreva a evolu√ß√£o do paciente..."></textarea>
                    <button class="btn btn-primary" onclick="addEvolution()" style="margin-top: 10px;">‚ûï Adicionar Evolu√ß√£o</button>
                </div>
                <div id="evolutionsList"></div>
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-danger" id="btnDeletePatient" onclick="deletePatient()" style="display:none">üóëÔ∏è Excluir</button>
                <button class="btn btn-primary" onclick="savePatient()">üíæ Salvar Paciente</button>
            </div>
        </div>
    </div>

    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nova Despesa</h3>
                <button class="close-btn" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Data *</label>
                <input type="date" id="expenseDate">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o *</label>
                <input type="text" id="expenseDesc">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="expenseCategory">
                    <option value="material">Material</option>
                    <option value="aluguel">Aluguel</option>
                    <option value="servicos">Servi√ßos</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            <div class="form-group">
                <label>Valor (R$) *</label>
                <input type="number" id="expenseValue" step="0.01">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveExpense()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // CONFIGURA√á√ÉO DOS PLANOS - SEM VALORES MONET√ÅRIOS
        const PLANS = {
            basic: {
                name: 'B√°sico',
                class: 'plan-basic',
                prefix: 'BS',
                features: ['documents'],
                description: 'Documentos Cl√≠nicos',
                details: 'Avalia√ß√£o, Evolu√ß√£o, Contrato, Recibo, TCLEs, Atestado, Reembolso, Alta, Encaminhamento'
            },
            gold: {
                name: 'Gold',
                class: 'plan-gold',
                prefix: 'GD',
                features: ['management'],
                description: 'Gest√£o Cl√≠nica',
                details: 'Agenda, Pacientes, Financeiro, Fluxo de Caixa, Relat√≥rios, Configura√ß√µes'
            },
            premium: {
                name: 'Premium',
                class: 'plan-premium',
                prefix: 'PM',
                features: ['documents', 'management'],
                description: 'Plano Completo',
                details: 'Todas as funcionalidades de Documentos + Gest√£o Cl√≠nica'
            }
        };

        const ALL_TABS = {
            documents: [
                { id: 'avaliacao', icon: 'üìã', label: 'Avalia√ß√£o' },
                { id: 'evolucao', icon: 'üìà', label: 'Evolu√ß√£o' },
                { id: 'contrato', icon: 'üìù', label: 'Contrato' },
                { id: 'recibo', icon: 'üí∞', label: 'Recibo' },
                { id: 'tcle-imagem', icon: 'üì∏', label: 'TCLE Imagem' },
                { id: 'tcle-tratamento', icon: 'ü§ù', label: 'TCLE Tratamento' },
                { id: 'atestado', icon: 'üìÑ', label: 'Atestado' },
                { id: 'reembolso', icon: 'üí≥', label: 'Reembolso' },
                { id: 'alta', icon: '‚úÖ', label: 'Alta' },
                { id: 'encaminhamento', icon: '‚û°Ô∏è', label: 'Encaminhamento' }
            ],
            management: [
                { id: 'agenda', icon: 'üìÖ', label: 'Agenda' },
                { id: 'pacientes', icon: 'üë•', label: 'Pacientes' },
                { id: 'financeiro', icon: 'üí∞', label: 'Financeiro' },
                { id: 'fluxo', icon: 'üìä', label: 'Fluxo de Caixa' },
                { id: 'relatorios', icon: 'üìà', label: 'Relat√≥rios' },
                { id: 'configuracoes', icon: '‚öôÔ∏è', label: 'Configura√ß√µes' }
            ]
        };

        let currentUser = null;
        let currentPlan = null;
        let activationCode = null;
        let userData = {
            config: { professionalName: '', crefito: '', clinicName: 'ASM Fisioterapia', pix: '' },
            patients: [],
            appointments: [],
            documents: [],
            evolutions: [],
            expenses: []
        };
        let currentDate = new Date();
        let currentApptId = null;
        let currentPatientId = null;
        let signatures = {};
        let selectedPainLevel = null;

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            setupCodeInputs();
            checkStoredActivation();
        });

        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.code-input');
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    input.value = input.value.toUpperCase();
                    if (input.value.length === 1 && index < 7) {
                        inputs[index + 1].focus();
                    }
                    detectPlanFromInput();
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value === '' && index > 0) {
                        inputs[index - 1].focus();
                    }
                    if (e.key === 'Enter') {
                        activateCode();
                    }
                });
            });
        }

        function detectPlanFromInput() {
            const inputs = document.querySelectorAll('.code-input');
            const prefix = (inputs[0].value + inputs[1].value).toUpperCase();
            
            let detectedPlan = null;
            if (prefix === 'BS') detectedPlan = 'basic';
            else if (prefix === 'GD') detectedPlan = 'gold';
            else if (prefix === 'PM') detectedPlan = 'premium';
            
            if (detectedPlan && prefix.length === 2) {
                showPlanPreview(detectedPlan);
            } else {
                document.getElementById('planInfo').classList.remove('active');
            }
        }

        function showPlanPreview(planKey) {
            const plan = PLANS[planKey];
            const planInfo = document.getElementById('planInfo');
            const badge = document.getElementById('planBadge');
            const title = document.getElementById('planTitle');
            const desc = document.getElementById('planDescription');
            
            badge.className = `plan-badge ${plan.class}`;
            badge.textContent = `Plano ${plan.name}`;
            title.textContent = plan.description;
            desc.textContent = plan.details;
            
            planInfo.classList.add('active');
        }

        async function checkStoredActivation() {
            const saved = localStorage.getItem('asm_activation');
            if (saved) {
                const data = JSON.parse(saved);
                const btn = document.getElementById('btnActivate');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Verificando...';
                
                try {
                    await window.signInAnonymously(window.auth);
                    const userRef = window.doc(window.db, 'users', data.code);
                    const userSnap = await window.getDoc(userRef);
                    
                    if (userSnap.exists() && userSnap.data().active !== false) {
                        activationCode = data.code;
                        currentPlan = detectPlanFromCode(data.code);
                        await loadUserData();
                        showDashboard();
                        return;
                    }
                    localStorage.removeItem('asm_activation');
                } catch (error) {
                    console.error('Erro:', error);
                }
                
                btn.disabled = false;
                btn.textContent = 'Ativar Sistema';
            }
        }

        function detectPlanFromCode(code) {
            const prefix = code.substring(0, 2).toUpperCase();
            if (prefix === 'BS') return 'basic';
            if (prefix === 'GD') return 'gold';
            if (prefix === 'PM') return 'premium';
            return null;
        }

        async function activateCode() {
            const inputs = document.querySelectorAll('.code-input');
            const code = Array.from(inputs).map(i => i.value).join('').toUpperCase();
            
            if (code.length !== 8) {
                showToast('‚ùå Digite o c√≥digo completo (8 caracteres)');
                return;
            }
            
            const detectedPlan = detectPlanFromCode(code);
            if (!detectedPlan) {
                showToast('‚ùå C√≥digo inv√°lido! Use BS, GD ou PM no in√≠cio');
                return;
            }
            
            const btn = document.getElementById('btnActivate');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Verificando...';
            
            try {
                await window.signInAnonymously(window.auth);
                
                const codeRef = window.doc(window.db, 'activationCodes', code);
                const codeSnap = await window.getDoc(codeRef);
                
                if (!codeSnap.exists()) {
                    throw new Error('C√≥digo n√£o encontrado no sistema');
                }
                
                const codeData = codeSnap.data();
                if (codeData.used) {
                    throw new Error('Este c√≥digo j√° foi utilizado');
                }
                
                await window.updateDoc(codeRef, {
                    used: true,
                    activatedAt: new Date().toISOString(),
                    deviceId: window.auth.currentUser.uid
                });
                
                await window.setDoc(window.doc(window.db, 'users', code), {
                    code: code,
                    plan: detectedPlan,
                    active: true,
                    activatedAt: new Date().toISOString(),
                    lastAccess: new Date().toISOString(),
                    config: userData.config,
                    patients: [],
                    appointments: [],
                    documents: [],
                    evolutions: [],
                    expenses: []
                });
                
                activationCode = code;
                currentPlan = detectedPlan;
                
                localStorage.setItem('asm_activation', JSON.stringify({
                    code: code,
                    plan: currentPlan,
                    activatedAt: new Date().toISOString()
                }));
                
                showDashboard();
                
            } catch (error) {
                showToast('‚ùå ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Ativar Sistema';
            }
        }

        function showDashboard() {
            document.getElementById('activationScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            const plan = PLANS[currentPlan];
            const tag = document.getElementById('planTag');
            tag.className = `plan-tag ${plan.class}`;
            tag.textContent = plan.name;
            
            document.getElementById('headerSubtitle').textContent = plan.description;
            
            generateMenu();
            generateSections();
            
            if (plan.features.includes('documents')) {
                showSection('documentos');
            } else {
                showSection('agenda');
            }
        }

        function generateMenu() {
            const menu = document.getElementById('mainMenu');
            const plan = PLANS[currentPlan];
            let items = [];
            
            if (plan.features.includes('documents')) {
                items.push({ id: 'documentos', icon: 'üìÑ', label: 'Documentos' });
            }
            if (plan.features.includes('management')) {
                items.push(
                    { id: 'agenda', icon: 'üìÖ', label: 'Agenda' },
                    { id: 'pacientes', icon: 'üë•', label: 'Pacientes' },
                    { id: 'financeiro', icon: 'üí∞', label: 'Financeiro' },
                    { id: 'fluxo', icon: 'üìä', label: 'Fluxo' },
                    { id: 'relatorios', icon: 'üìà', label: 'Relat√≥rios' },
                    { id: 'configuracoes', icon: '‚öôÔ∏è', label: 'Config' }
                );
            }
            
            menu.innerHTML = items.map((item, index) => `
                <button class="menu-btn ${index === 0 ? 'active' : ''}" onclick="showSection('${item.id}')" data-section="${item.id}">
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                </button>
            `).join('');
        }

        function generateSections() {
            const container = document.getElementById('sectionContainer');
            const plan = PLANS[currentPlan];
            let html = '';
            
            if (plan.features.includes('documents')) {
                html += generateDocumentsSection();
            }
            if (plan.features.includes('management')) {
                html += generateManagementSections();
            }
            
            container.innerHTML = html;
            setTimeout(initializeComponents, 100);
        }

        function generateDocumentsSection() {
            const tabs = ALL_TABS.documents;
            return `
                <div id="documentos" class="section">
                    <h2 class="section-title">üìÑ Documentos Cl√≠nicos</h2>
                    <div class="doc-tabs">
                        ${tabs.map((tab, i) => `
                            <button class="doc-tab ${i === 0 ? 'active' : ''}" onclick="showDocTab('${tab.id}')">
                                ${tab.icon} ${tab.label}
                            </button>
                        `).join('')}
                    </div>
                    ${tabs.map((tab, i) => `
                        <div id="doc-${tab.id}" class="doc-content ${i === 0 ? 'active' : ''}">
                            ${getDocumentForm(tab.id)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateManagementSections() {
            return `
                <div id="agenda" class="section">
                    <h2 class="section-title">üìÖ Agenda</h2>
                    <div class="calendar-header">
                        <button class="btn btn-primary" onclick="changeMonth(-1)">‚Üê Anterior</button>
                        <h3 id="currentMonth"></h3>
                        <button class="btn btn-primary" onclick="changeMonth(1)">Pr√≥ximo ‚Üí</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="openAppointmentModal()">+ Novo Agendamento</button>
                    </div>
                </div>

                <div id="pacientes" class="section">
                    <h2 class="section-title">üë• Pacientes</h2>
                    <div class="form-group">
                        <input type="text" placeholder="Buscar paciente..." oninput="searchPatients(this.value)" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="openPatientModal()">+ Novo Paciente</button>
                    </div>
                    <div id="patientsList" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;"></div>
                </div>

                <div id="financeiro" class="section">
                    <h2 class="section-title">üí∞ Financeiro</h2>
                    <div class="summary-cards">
                        <div class="summary-card green"><h3 id="totalReceived">R$ 0,00</h3><p>Recebido</p></div>
                        <div class="summary-card red"><h3 id="totalPending">R$ 0,00</h3><p>A Receber</p></div>
                        <div class="summary-card blue"><h3 id="totalSessions">0</h3><p>Sess√µes</p></div>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>Paciente</th><th>Data</th><th>Servi√ßo</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="financialTable"></tbody>
                    </table>
                </div>

                <div id="fluxo" class="section">
                    <h2 class="section-title">üìä Fluxo de Caixa</h2>
                    <div class="form-group">
                        <label>M√™s/Ano</label>
                        <input type="month" id="cashFlowMonth" onchange="renderCashFlow()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div class="summary-cards">
                        <div class="summary-card green"><h3 id="cfEntries">R$ 0,00</h3><p>Entradas</p></div>
                        <div class="summary-card red"><h3 id="cfExits">R$ 0,00</h3><p>Sa√≠das</p></div>
                        <div class="summary-card gold"><h3 id="cfBalance">R$ 0,00</h3><p>Saldo</p></div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-danger" onclick="openExpenseModal()">+ Registrar Despesa</button>
                    </div>
                    <div id="cashFlowContent"></div>
                </div>

                <div id="relatorios" class="section">
                    <h2 class="section-title">üìà Relat√≥rios</h2>
                    <div class="form-group">
                        <label>M√™s/Ano</label>
                        <input type="month" id="reportMonth" onchange="renderReports()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div class="summary-cards">
                        <div class="summary-card blue"><h3 id="reportSessions">0</h3><p>Atendimentos</p></div>
                        <div class="summary-card green"><h3 id="reportRevenue">R$ 0,00</h3><p>Faturamento</p></div>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>Paciente</th><th>Sess√µes</th><th>Total</th></tr></thead>
                        <tbody id="reportTable"></tbody>
                    </table>
                </div>

                <div id="configuracoes" class="section">
                    <h2 class="section-title">‚öôÔ∏è Configura√ß√µes</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome do Profissional *</label>
                            <input type="text" id="configName">
                        </div>
                        <div class="form-group">
                            <label>CREFITO *</label>
                            <input type="text" id="configCrefito">
                        </div>
                        <div class="form-group">
                            <label>Nome da Cl√≠nica</label>
                            <input type="text" id="configClinic" value="ASM Fisioterapia">
                        </div>
                        <div class="form-group">
                            <label>Chave Pix</label>
                            <input type="text" id="configPix">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar Configura√ß√µes</button>
                    </div>
                </div>
            `;
        }

        function getDocumentForm(type) {
            const forms = {
                'avaliacao': `
                    <div class="form-grid">
                        <div class="form-group"><label>Fisioterapeuta *</label><input type="text" id="av-nomeFisio"></div>
                        <div class="form-group"><label>CREFITO *</label><input type="text" id="av-crefito"></div>
                        <div class="form-group"><label>Paciente *</label><input type="text" id="av-nomePaciente"></div>
                        <div class="form-group"><label>Data *</label><input type="date" id="av-data"></div>
                        <div class="form-group"><label>Idade</label><input type="number" id="av-idade"></div>
                        <div class="form-group"><label>Profiss√£o</label><input type="text" id="av-profissao"></div>
                    </div>
                    <div class="form-group"><label>Queixa Principal *</label><textarea id="av-queixa" rows="4"></textarea></div>
                    <div class="form-group"><label>Hist√≥rico da Dor</label><textarea id="av-historico" rows="3"></textarea></div>
                    <div class="pain-scale">
                        <label><strong>Escala de Dor (0-10)</strong></label>
                        <div class="pain-numbers" id="painScale">
                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => 
                                `<div class="pain-number ${n<=3?'low':n<=6?'medium':'high'}" onclick="selectPain(this, ${n})">${n}</div>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="form-group"><label>Exame F√≠sico</label><textarea id="av-exame" rows="4"></textarea></div>
                    <div class="form-group"><label>Diagn√≥stico Fisioterap√™utico</label><textarea id="av-diagnostico" rows="3"></textarea></div>
                    <div class="form-group"><label>Plano de Tratamento</label><textarea id="av-plano" rows="3"></textarea></div>
                    <div class="signature-area">
                        <canvas id="av-assinatura" class="signature-pad"></canvas>
                        <span class="signature-label">Assinatura do Paciente</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('avaliacao')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('avaliacao')">üìÑ Gerar PDF</button>
                        <button class="btn btn-whatsapp" onclick="sendWhatsApp('avaliacao')">üì± WhatsApp</button>
                    </div>
                `,
                'evolucao': `
                    <div class="form-grid">
                        <div class="form-group"><label>Paciente *</label><select id="ev-paciente"><option value="">Selecione...</option></select></div>
                        <div class="form-group"><label>Data *</label><input type="date" id="ev-data"></div>
                    </div>
                    <div class="form-group"><label>Evolu√ß√£o do Paciente *</label><textarea id="ev-texto" rows="6" placeholder="Descreva a evolu√ß√£o, resposta ao tratamento, altera√ß√µes..."></textarea></div>
                    <div class="form-group"><label>Conduta</label><textarea id="ev-conduta" rows="3"></textarea></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('evolucao')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('evolucao')">üìÑ Gerar PDF</button>
                        <button class="btn btn-whatsapp" onclick="sendWhatsApp('evolucao')">üì± WhatsApp</button>
                    </div>
                `,
                'contrato': `
                    <div class="form-grid">
                        <div class="form-group"><label>Contratante *</label><input type="text" id="ct-nome"></div>
                        <div class="form-group"><label>CPF *</label><input type="text" id="ct-cpf"></div>
                        <div class="form-group"><label>Endere√ßo</label><input type="text" id="ct-endereco"></div>
                        <div class="form-group"><label>Telefone</label><input type="text" id="ct-telefone"></div>
                    </div>
                    <div class="form-group"><label>Objeto do Contrato</label><textarea id="ct-objeto" rows="3">Presta√ß√£o de servi√ßos fisioterap√™uticos</textarea></div>
                    <div class="form-grid">
                        <div class="form-group"><label>Valor da Sess√£o (R$)</label><input type="number" id="ct-valor" step="0.01"></div>
                        <div class="form-group"><label>Frequ√™ncia</label><input type="text" id="ct-frequencia" placeholder="Ex: 2x por semana"></div>
                    </div>
                    <div class="signature-area">
                        <canvas id="ct-assinatura" class="signature-pad"></canvas>
                        <span class="signature-label">Assinatura do Contratante</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('contrato')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('contrato')">üìÑ Gerar PDF</button>
                    </div>
                `,
                'recibo': `
                    <div class="form-grid">
                        <div class="form-group"><label>N¬∫ do Recibo *</label><input type="text" id="rc-numero"></div>
                        <div class="form-group"><label>Data *</label><input type="date" id="rc-data"></div>
                        <div class="form-group"><label>Recebido de *</label><input type="text" id="rc-nome"></div>
                        <div class="form-group"><label>CPF/CNPJ</label><input type="text" id="rc-cpf"></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Valor (R$) *</label><input type="number" id="rc-valor" step="0.01"></div>
                        <div class="form-group"><label>Forma de Pagamento</label>
                            <select id="rc-forma">
                                <option value="Pix">Pix</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cart√£o">Cart√£o</option>
                                <option value="Transfer√™ncia">Transfer√™ncia</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group"><label>Referente a</label><input type="text" id="rc-referente" placeholder="Ex: Sess√£o de fisioterapia"></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('recibo')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('recibo')">üìÑ Gerar PDF</button>
                        <button class="btn btn-whatsapp" onclick="sendWhatsApp('recibo')">üì± WhatsApp</button>
                    </div>
                `,
                'tcle-imagem': `
                    <div class="form-grid">
                        <div class="form-group"><label>Paciente *</label><input type="text" id="ti-nome"></div>
                        <div class="form-group"><label>Data *</label><input type="date" id="ti-data"></div>
                    </div>
                    <div class="form-group"><label>Autoriza√ß√£o</label>
                        <p style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 0.9rem; line-height: 1.6;">
                            Autorizo o uso da minha imagem para fins de registro cl√≠nico, educacionais e divulga√ß√£o cient√≠fica, 
                            desde que n√£o revele minha identidade sem permiss√£o pr√©via.
                        </p>
                    </div>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="checkbox" id="ti-registro"> Registro Cl√≠nico</label>
                        <label class="checkbox-item"><input type="checkbox" id="ti-educativo"> Uso Educacional</label>
                        <label class="checkbox-item"><input type="checkbox" id="ti-divulgacao"> Divulga√ß√£o Cient√≠fica</label>
                    </div>
                    <div class="signature-area">
                        <canvas id="ti-assinatura" class="signature-pad"></canvas>
                        <span class="signature-label">Assinatura do Paciente/Respons√°vel</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('tcle-imagem')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('tcle-imagem')">üìÑ Gerar PDF</button>
                    </div>
                `,
                'tcle-tratamento': `
                    <div class="form-grid">
                        <div class="form-group"><label>Paciente *</label><input type="text" id="tt-nome"></div>
                        <div class="form-group"><label>Data *</label><input type="date" id="tt-data"></div>
                    </div>
                    <div class="form-group"><label>Termo de Consentimento</label>
                        <p style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 0.9rem; line-height: 1.6;">
                            Declaro que fui informado(a) sobre os procedimentos fisioterap√™uticos, seus benef√≠cios, 
                            riscos e alternativas, e dou meu consentimento para a realiza√ß√£o do tratamento proposto.
                        </p>
                    </div>
                    <div class="form-group"><label>Procedimentos</label><textarea id="tt-procedimentos" rows="3"></textarea></div>
                    <div class="signature-area">
                        <canvas id="tt-assinatura" class="signature-pad"></canvas>
                        <span class="signature-label">Assinatura do Paciente/Respons√°vel</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('tcle-tratamento')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('tcle-tratamento')">üìÑ Gerar PDF</button>
                    </div>
                `,
                'atestado': `
                    <div class="form-grid">
                        <div class="form-group"><label>Paciente *</label><input type="text" id="at-nome"></div>
                        <div class="form-group"><label>Data *</label><input type="date" id="at-data"></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Per√≠odo de Afastamento *</label><input type="number" id="at-dias" placeholder="Dias"></div>
                        <div class="form-group"><label>CID (opcional)</label><input type="text" id="at-cid"></div>
                    </div>
                    <div class="form-group"><label>Motivo/Recomenda√ß√£o</label><textarea id="at-motivo" rows="3"></textarea></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('atestado')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('atestado')">üìÑ Gerar PDF</button>
                        <button class="btn btn-whatsapp" onclick="sendWhatsApp('atestado')">üì± WhatsApp</button>
                    </div>
                `,
                'reembolso': `
                    <div class="form-grid">
                        <div class="form-group"><label>Paciente *</label><input type="text" id="rb-nome"></div>
                        <div class="form-group"><label>Plano/Conv√™nio *</label><input type="text" id="rb-plano"></div>
                        <div class="form-group"><label>N¬∫ da Carteirinha</label><input type="text" id="rb-carteirinha"></div>
                        <div class="form-group"><label>Per√≠odo de Tratamento</label><input type="text" id="rb-periodo" placeholder="Ex: 01/01/2024 a 31/01/2024"></div>
                    </div>
                    <div class="form-group"><label>Diagn√≥stico M√©dico/CID</label><input type="text" id="rb-diagnostico"></div>
                    <div class="form-group"><label>Quantidade de Sess√µes</label><input type="number" id="rb-sessoes"></div>
                    <div class="form-group"><label>Valor Total (R$)</label><input type="number" id="rb-valor" step="0.01"></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('reembolso')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('reembolso')">üìÑ Gerar PDF</button>
                    </div>
                `,
                'alta': `
                    <div class="form-grid">
                        <div class="form-group"><label>Paciente *</label><input type="text" id="al-nome"></div>
                        <div class="form-group"><label>Data da Alta *</label><input type="date" id="al-data"></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Data In√≠cio Tratamento</label><input type="date" id="al-inicio"></div>
                        <div class="form-group"><label>Total de Sess√µes</label><input type="number" id="al-sessoes"></div>
                    </div>
                    <div class="form-group"><label>Diagn√≥stico Inicial</label><textarea id="al-diagnostico-inicial" rows="3"></textarea></div>
                    <div class="form-group"><label>Evolu√ß√£o do Tratamento</label><textarea id="al-evolucao" rows="4"></textarea></div>
                    <div class="form-group"><label>Condi√ß√£o Final</label><textarea id="al-condicao" rows="3"></textarea></div>
                    <div class="form-group"><label>Recomenda√ß√µes</label><textarea id="al-recomendacoes" rows="3"></textarea></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('alta')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('alta')">üìÑ Gerar PDF</button>
                    </div>
                `,
                'encaminhamento': `
                    <div class="form-grid">
                        <div class="form-group"><label>Paciente *</label><input type="text" id="en-nome"></div>
                        <div class="form-group"><label>Data *</label><input type="date" id="en-data"></div>
                    </div>
                    <div class="form-group"><label>Encaminhado para *</label><input type="text" id="en-destino" placeholder="Nome do profissional/especialidade"></div>
                    <div class="form-group"><label>Motivo do Encaminhamento *</label><textarea id="en-motivo" rows="4"></textarea></div>
                    <div class="form-group"><label>Resumo do Caso</label><textarea id="en-resumo" rows="4"></textarea></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveDocument('encaminhamento')">üíæ Salvar na Nuvem</button>
                        <button class="btn btn-success" onclick="generatePDF('encaminhamento')">üìÑ Gerar PDF</button>
                    </div>
                `
            };
            return forms[type] || '<p>Formul√°rio em desenvolvimento</p>';
        }

        // NAVEGA√á√ÉO
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('active');
            
            const btn = document.querySelector(`[data-section="${sectionId}"]`);
            if (btn) btn.classList.add('active');
            
            if (sectionId === 'agenda') renderCalendar();
            if (sectionId === 'pacientes') renderPatients();
            if (sectionId === 'financeiro') renderFinancial();
            if (sectionId === 'fluxo') renderCashFlow();
            if (sectionId === 'relatorios') renderReports();
            if (sectionId === 'configuracoes') loadConfig();
            if (sectionId === 'documentos') initializeSignatures();
        }

        function showDocTab(tabId) {
            document.querySelectorAll('.doc-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.doc-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(`doc-${tabId}`).classList.add('active');
            event.target.classList.add('active');
            
            setTimeout(initializeSignatures, 100);
        }

        // FUN√á√ïES DE DADOS
        async function loadUserData() {
            try {
                const userRef = window.doc(window.db, 'users', activationCode);
                const userSnap = await window.getDoc(userRef);
                
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    userData = {
                        config: data.config || { professionalName: '', crefito: '', clinicName: 'ASM Fisioterapia', pix: '' },
                        patients: data.patients || [],
                        appointments: data.appointments || [],
                        documents: data.documents || [],
                        evolutions: data.evolutions || [],
                        expenses: data.expenses || []
                    };
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        async function saveUserData() {
            try {
                await window.updateDoc(window.doc(window.db, 'users', activationCode), {
                    ...userData,
                    lastUpdated: new Date().toISOString()
                });
                showToast('‚úÖ Dados salvos na nuvem!');
            } catch (error) {
                showToast('‚ùå Erro ao salvar. Tente novamente.');
            }
        }

        // ASSINATURAS
        function initializeSignatures() {
            const canvases = document.querySelectorAll('.signature-pad');
            canvases.forEach(canvas => {
                if (signatures[canvas.id]) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                
                canvas.width = container.offsetWidth - 4;
                canvas.height = 150;
                
                ctx.strokeStyle = '#1e3a5f';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                let isDrawing = false;
                
                function startDrawing(e) {
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX || e.touches[0].clientX) - rect.left;
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    
                    const label = canvas.parentElement.querySelector('.signature-label');
                    if (label) label.style.display = 'none';
                }
                
                function draw(e) {
                    if (!isDrawing) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX || e.touches[0].clientX) - rect.left;
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }
                
                function stopDrawing() {
                    isDrawing = false;
                }
                
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); }, {passive: false});
                canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, {passive: false});
                canvas.addEventListener('touchend', stopDrawing);
                
                signatures[canvas.id] = { canvas, ctx, hasData: false };
            });
        }

        function clearSignature(canvasId) {
            if (signatures[canvasId]) {
                const { canvas, ctx } = signatures[canvasId];
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                signatures[canvasId].hasData = false;
                
                const label = canvas.parentElement.querySelector('.signature-label');
                if (label) label.style.display = 'block';
            }
        }

        // DOCUMENTOS
        function selectPain(element, level) {
            document.querySelectorAll('.pain-number').forEach(n => n.classList.remove('selected'));
            element.classList.add('selected');
            selectedPainLevel = level;
        }

        async function saveDocument(type) {
            const docData = {
                type: type,
                createdAt: new Date().toISOString(),
                code: activationCode,
                painLevel: selectedPainLevel
            };
            
            const inputs = document.querySelectorAll(`#doc-${type} input, #doc-${type} textarea, #doc-${type} select`);
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    docData[input.id] = input.checked;
                } else {
                    docData[input.id] = input.value;
                }
            });
            
            // Capturar assinatura se existir
            const canvas = document.querySelector(`#doc-${type} .signature-pad`);
            if (canvas && signatures[canvas.id] && signatures[canvas.id].hasData !== false) {
                docData.signature = canvas.toDataURL();
            }
            
            userData.documents.push(docData);
            await saveUserData();
            
            showToast('‚úÖ Documento salvo com sucesso!');
        }

        function generatePDF(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Cabe√ßalho
            doc.setFillColor(30, 58, 95);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(201, 162, 39);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text(userData.config.clinicName || 'ASM Fisioterapia', 105, 20, { align: 'center' });
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(userData.config.professionalName || 'Profissional', 105, 30, { align: 'center' });
            doc.text(userData.config.crefito || '', 105, 37, { align: 'center' });
            
            doc.setDrawColor(201, 162, 39);
            doc.setLineWidth(1);
            doc.line(20, 50, 190, 50);
            
            // T√≠tulo do documento
            const titles = {
                'avaliacao': 'FICHA DE AVALIA√á√ÉO FISIOTERAP√äUTICA',
                'evolucao': 'EVOLU√á√ÉO DE TRATAMENTO',
                'contrato': 'CONTRATO DE PRESTA√á√ÉO DE SERVI√áOS',
                'recibo': 'RECIBO DE PAGAMENTO',
                'tcle-imagem': 'TCLE - USO DE IMAGEM',
                'tcle-tratamento': 'TCLE - CONSENTIMENTO PARA TRATAMENTO',
                'atestado': 'ATESTADO FISIOTERAP√äUTICO',
                'reembolso': 'RELAT√ìRIO PARA REEMBOLSO',
                'alta': 'RELAT√ìRIO DE ALTA',
                'encaminhamento': 'ENCAMINHAMENTO PROFISSIONAL'
            };
            
            doc.setTextColor(30, 58, 95);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(titles[type] || 'DOCUMENTO', 105, 65, { align: 'center' });
            
            // Conte√∫do
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            let y = 80;
            
            const inputs = document.querySelectorAll(`#doc-${type} input, #doc-${type} textarea, #doc-${type} select`);
            inputs.forEach(input => {
                if (input.value && !input.id.includes('assinatura')) {
                    const label = input.previousElementSibling?.textContent || input.id;
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${label}:`, 20, y);
                    doc.setFont('helvetica', 'normal');
                    
                    const value = input.value;
                    const splitText = doc.splitTextToSize(value, 170);
                    doc.text(splitText, 20, y + 5);
                    y += 5 + (splitText.length * 5);
                    
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                }
            });
            
            // Rodap√©
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`¬© ${new Date().getFullYear()} ${userData.config.clinicName || 'ASM Fisioterapia'} - Dra. Andresa Augusto`, 105, 285, { align: 'center' });
                doc.text('Proibida reprodu√ß√£o sem autoriza√ß√£o', 105, 290, { align: 'center' });
            }
            
            doc.save(`${type}_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('üìÑ PDF gerado com sucesso!');
        }

        function sendWhatsApp(type) {
            const phone = prompt('Digite o n√∫mero de WhatsApp (com DDD):');
            if (!phone) return;
            
            const cleanPhone = phone.replace(/\D/g, '');
            let message = '';
            
            const patientName = document.querySelector(`#doc-${type} input[id*="-nome"]`)?.value || 'Paciente';
            
            const messages = {
                'avaliacao': `Ol√° ${patientName}! Segue sua avalia√ß√£o fisioterap√™utica.`,
                'evolucao': `Ol√° ${patientName}! Segue o registro da sua evolu√ß√£o.`,
                'recibo': `Ol√° ${patientName}! Segue seu recibo de pagamento.`,
                'atestado': `Ol√° ${patientName}! Segue seu atestado.`
            };
            
            message = messages[type] || `Ol√° ${patientName}! Segue documento.`;
            
            window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // GEST√ÉO - AGENDA
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            if (!grid) return;
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            let html = days.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
            
            const today = new Date();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const dayAppointments = userData.appointments.filter(a => a.date === dateStr && !a.cancelled);
                
                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="openAppointmentModal('${dateStr}')">
                        <div style="font-weight: bold; margin-bottom: 5px;">${day}</div>
                        ${dayAppointments.map(appt => {
                            const patient = userData.patients.find(p => p.id === appt.patientId);
                            return `<div class="appointment-item" onclick="event.stopPropagation(); editAppointment('${appt.id}')">${appt.time} ${patient ? patient.name.split(' ')[0] : ''}</div>`;
                        }).join('')}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function openAppointmentModal(date = null) {
            currentApptId = null;
            document.getElementById('apptPatient').innerHTML = '<option value="">Selecione...</option>' + 
                userData.patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            document.getElementById('apptDate').value = date || new Date().toISOString().split('T')[0];
            document.getElementById('apptTime').value = '';
            document.getElementById('apptType').value = 'normal';
            document.getElementById('apptValue').value = '';
            document.getElementById('apptNotes').value = '';
            
            document.getElementById('btnWhatsAppt').style.display = 'none';
            document.getElementById('btnToggleCancel').style.display = 'none';
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        function editAppointment(id) {
            const appt = userData.appointments.find(a => a.id === id);
            if (!appt) return;
            
            currentApptId = id;
            
            document.getElementById('apptPatient').innerHTML = '<option value="">Selecione...</option>' + 
                userData.patients.map(p => `<option value="${p.id}" ${p.id === appt.patientId ? 'selected' : ''}>${p.name}</option>`).join('');
            
            document.getElementById('apptDate').value = appt.date;
            document.getElementById('apptTime').value = appt.time;
            document.getElementById('apptType').value = appt.type;
            document.getElementById('apptValue').value = appt.value;
            document.getElementById('apptNotes').value = appt.notes || '';
            
            document.getElementById('btnWhatsAppt').style.display = 'inline-block';
            document.getElementById('btnToggleCancel').style.display = 'inline-block';
            
            const btnCancel = document.getElementById('btnToggleCancel');
            if (appt.cancelled) {
                btnCancel.textContent = '‚Ü© Reativar';
                btnCancel.className = 'btn btn-success';
            } else {
                btnCancel.textContent = '‚ùå Cancelar';
                btnCancel.className = 'btn btn-warning';
            }
            
            document.getElementById('appointmentModal').classList.add('active');
        }

        async function saveAppointment() {
            const patientId = document.getElementById('apptPatient').value;
            if (!patientId) {
                alert('Selecione um paciente!');
                return;
            }
            
            const apptData = {
                id: currentApptId || Date.now().toString(),
                patientId: patientId,
                date: document.getElementById('apptDate').value,
                time: document.getElementById('apptTime').value,
                type: document.getElementById('apptType').value,
                value: parseFloat(document.getElementById('apptValue').value) || 0,
                notes: document.getElementById('apptNotes').value,
                paid: currentApptId ? userData.appointments.find(a => a.id === currentApptId)?.paid : false,
                cancelled: currentApptId ? userData.appointments.find(a => a.id === currentApptId)?.cancelled : false
            };
            
            if (currentApptId) {
                const idx = userData.appointments.findIndex(a => a.id === currentApptId);
                userData.appointments[idx] = apptData;
            } else {
                userData.appointments.push(apptData);
            }
            
            await saveUserData();
            closeModal('appointmentModal');
            renderCalendar();
            updateFinancialSummary();
        }

        function toggleCancelAppointment() {
            if (!currentApptId) return;
            
            const appt = userData.appointments.find(a => a.id === currentApptId);
            appt.cancelled = !appt.cancelled;
            
            saveUserData().then(() => {
                closeModal('appointmentModal');
                renderCalendar();
                updateFinancialSummary();
            });
        }

        function sendAppointmentWhatsApp() {
            if (!currentApptId) return;
            
            const appt = userData.appointments.find(a => a.id === currentApptId);
            const patient = userData.patients.find(p => p.id === appt.patientId);
            
            let message = `Ol√° ${patient.name}! Tudo bem?\n\n`;
            message += `Confirma√ß√£o de agendamento:\n`;
            message += `üìÖ Data: ${formatDateBR(appt.date)}\n`;
            message += `‚è∞ Hor√°rio: ${appt.time}\n`;
            message += `üìç Local: ${userData.config.clinicName}\n\n`;
            
            if (appt.cancelled) {
                message += `‚ö†Ô∏è ATEN√á√ÉO: Agendamento CANCELADO.\n`;
            } else {
                message += `Estamos te aguardando!`;
            }
            
            window.open(`https://wa.me/55${patient.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`, '_blank');
        }

        // GEST√ÉO - PACIENTES
        function renderPatients() {
            const list = document.getElementById('patientsList');
            if (!list) return;
            
            if (userData.patients.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Nenhum paciente cadastrado</p>';
                return;
            }
            
            list.innerHTML = userData.patients.map(p => {
                const pendingAppts = userData.appointments.filter(a => a.patientId === p.id && !a.cancelled && !a.paid);
                return `
                    <div class="patient-card" onclick="openPatientModal('${p.id}')">
                        <h3 style="color: var(--azul-marinho); margin-bottom: 8px;">${p.name}</h3>
                        <p style="color: #666; font-size: 0.9rem;">üì± ${p.phone}</p>
                        ${pendingAppts.length > 0 ? `<p style="color: var(--vermelho); font-size: 0.85rem; margin-top: 5px;">‚ö†Ô∏è ${pendingAppts.length} pendente(s)</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function searchPatients(term) {
            const cards = document.querySelectorAll('.patient-card');
            cards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                card.style.display = name.includes(term.toLowerCase()) ? 'block' : 'none';
            });
        }

        function openPatientModal(patientId = null) {
            currentPatientId = patientId;
            
            if (patientId) {
                const p = userData.patients.find(x => x.id === patientId);
                document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
                document.getElementById('patientId').value = p.id;
                document.getElementById('patientName').value = p.name;
                document.getElementById('patientPhone').value = p.phone;
                document.getElementById('patientEmail').value = p.email || '';
                document.getElementById('patientValue').value = p.defaultValue || '';
                document.getElementById('patientComplaint').value = p.complaint || '';
                document.getElementById('btnDeletePatient').style.display = 'inline-block';
                
                // Mostrar evolu√ß√µes
                document.getElementById('patientEvolutions').style.display = 'block';
                renderEvolutions(patientId);
            } else {
                document.getElementById('patientModalTitle').textContent = 'Novo Paciente';
                document.getElementById('patientId').value = '';
                document.getElementById('patientName').value = '';
                document.getElementById('patientPhone').value = '';
                document.getElementById('patientEmail').value = '';
                document.getElementById('patientValue').value = '';
                document.getElementById('patientComplaint').value = '';
                document.getElementById('btnDeletePatient').style.display = 'none';
                document.getElementById('patientEvolutions').style.display = 'none';
            }
            
            document.getElementById('patientModal').classList.add('active');
        }

        async function savePatient() {
            const id = document.getElementById('patientId').value;
            const data = {
                id: id || Date.now().toString(),
                name: document.getElementById('patientName').value.trim(),
                phone: document.getElementById('patientPhone').value.trim(),
                email: document.getElementById('patientEmail').value.trim(),
                defaultValue: parseFloat(document.getElementById('patientValue').value) || 0,
                complaint: document.getElementById('patientComplaint').value.trim()
            };
            
            if (!data.name || !data.phone) {
                alert('Preencha nome e telefone!');
                return;
            }
            
            if (id) {
                const idx = userData.patients.findIndex(p => p.id === id);
                userData.patients[idx] = data;
            } else {
                userData.patients.push(data);
            }
            
            await saveUserData();
            closeModal('patientModal');
            renderPatients();
        }

        async function deletePatient() {
            if (!confirm('Excluir paciente e todos os seus dados?')) return;
            
            userData.patients = userData.patients.filter(p => p.id !== currentPatientId);
            userData.appointments = userData.appointments.filter(a => a.patientId !== currentPatientId);
            userData.evolutions = userData.evolutions.filter(e => e.patientId !== currentPatientId);
            
            await saveUserData();
            closeModal('patientModal');
            renderPatients();
            renderCalendar();
        }

        function renderEvolutions(patientId) {
            const list = document.getElementById('evolutionsList');
            const patientEvos = userData.evolutions.filter(e => e.patientId === patientId).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (patientEvos.length === 0) {
                list.innerHTML = '<p style="color: #666; font-size: 0.9rem;">Nenhuma evolu√ß√£o registrada</p>';
                return;
            }
            
            list.innerHTML = patientEvos.map(evo => `
                <div class="evolution-item">
                    <small style="color: #666;">${formatDateBR(evo.date)} √†s ${evo.time}</small>
                    <p style="margin-top: 5px;">${evo.text}</p>
                </div>
            `).join('');
        }

        async function addEvolution() {
            const text = document.getElementById('newEvolution').value.trim();
            if (!text) return;
            
            const now = new Date();
            userData.evolutions.push({
                id: Date.now().toString(),
                patientId: currentPatientId,
                date: now.toISOString().split('T')[0],
                time: now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                text: text
            });
            
            await saveUserData();
            document.getElementById('newEvolution').value = '';
            renderEvolutions(currentPatientId);
        }

        // GEST√ÉO - FINANCEIRO
        function updateFinancialSummary() {
            const activeAppts = userData.appointments.filter(a => !a.cancelled);
            const received = activeAppts.filter(a => a.paid).reduce((s, a) => s + (a.value || 0), 0);
            const pending = activeAppts.filter(a => !a.paid).reduce((s, a) => s + (a.value || 0), 0);
            
            document.getElementById('totalReceived').textContent = `R$ ${received.toFixed(2)}`;
            document.getElementById('totalPending').textContent = `R$ ${pending.toFixed(2)}`;
            document.getElementById('totalSessions').textContent = activeAppts.length;
        }

        function renderFinancial() {
            updateFinancialSummary();
            
            const tbody = document.getElementById('financialTable');
            const pendingAppts = userData.appointments.filter(a => !a.cancelled && !a.paid).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = pendingAppts.map(appt => {
                const patient = userData.patients.find(p => p.id === appt.patientId);
                return `
                    <tr>
                        <td>${patient ? patient.name : 'Paciente removido'}</td>
                        <td>${formatDateBR(appt.date)}</td>
                        <td>${appt.type}</td>
                        <td>R$ ${(appt.value || 0).toFixed(2)}</td>
                        <td>‚è≥ Pendente</td>
                        <td><button class="btn btn-primary" onclick="togglePayment('${appt.id}')">Pagar</button></td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="6" style="text-align: center;">Nenhum pagamento pendente</td></tr>';
        }

        async function togglePayment(id) {
            const appt = userData.appointments.find(a => a.id === id);
            appt.paid = !appt.paid;
            await saveUserData();
            renderFinancial();
            renderCalendar();
        }

        // GEST√ÉO - FLUXO DE CAIXA
        function renderCashFlow() {
            const month = document.getElementById('cashFlowMonth').value;
            if (!month) {
                document.getElementById('cashFlowMonth').value = new Date().toISOString().slice(0, 7);
                return;
            }
            
            const entries = userData.appointments.filter(a => !a.cancelled && a.paid && a.date.startsWith(month));
            const monthExpenses = userData.expenses.filter(e => e.date.startsWith(month));
            
            const totalEntries = entries.reduce((s, a) => s + (a.value || 0), 0);
            const totalExits = monthExpenses.reduce((s, e) => s + (e.value || 0), 0);
            
            document.getElementById('cfEntries').textContent = `R$ ${totalEntries.toFixed(2)}`;
            document.getElementById('cfExits').textContent = `R$ ${totalExits.toFixed(2)}`;
            document.getElementById('cfBalance').textContent = `R$ ${(totalEntries - totalExits).toFixed(2)}`;
        }

        function openExpenseModal() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseCategory').value = 'material';
            document.getElementById('expenseValue').value = '';
            document.getElementById('expenseModal').classList.add('active');
        }

        async function saveExpense() {
            const data = {
                id: Date.now().toString(),
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDesc').value.trim(),
                category: document.getElementById('expenseCategory').value,
                value: parseFloat(document.getElementById('expenseValue').value) || 0
            };
            
            if (!data.date || !data.description || !data.value) {
                alert('Preencha todos os campos!');
                return;
            }
            
            userData.expenses.push(data);
            await saveUserData();
            closeModal('expenseModal');
            renderCashFlow();
        }

        // GEST√ÉO - RELAT√ìRIOS
        function renderReports() {
            const month = document.getElementById('reportMonth').value;
            if (!month) {
                document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
                return;
            }
            
            const monthAppts = userData.appointments.filter(a => !a.cancelled && a.date.startsWith(month));
            const totalRevenue = monthAppts.reduce((s, a) => s + (a.value || 0), 0);
            
            document.getElementById('reportSessions').textContent = monthAppts.length;
            document.getElementById('reportRevenue').textContent = `R$ ${totalRevenue.toFixed(2)}`;
            
            // Agrupar por paciente
            const byPatient = {};
            monthAppts.forEach(appt => {
                if (!byPatient[appt.patientId]) {
                    byPatient[appt.patientId] = { sessions: 0, total: 0 };
                }
                byPatient[appt.patientId].sessions++;
                byPatient[appt.patientId].total += appt.value || 0;
            });
            
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = Object.entries(byPatient)
                .sort((a, b) => b[1].sessions - a[1].sessions)
                .map(([patientId, stats]) => {
                    const patient = userData.patients.find(p => p.id === patientId);
                    return `
                        <tr>
                            <td>${patient ? patient.name : 'Paciente removido'}</td>
                            <td>${stats.sessions}</td>
                            <td>R$ ${stats.total.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="3" style="text-align: center;">Nenhum atendimento no per√≠odo</td></tr>';
        }

        // CONFIGURA√á√ïES
        function loadConfig() {
            document.getElementById('configName').value = userData.config.professionalName;
            document.getElementById('configCrefito').value = userData.config.crefito;
            document.getElementById('configClinic').value = userData.config.clinicName;
            document.getElementById('configPix').value = userData.config.pix;
        }

        async function saveConfig() {
            userData.config = {
                professionalName: document.getElementById('configName').value.trim(),
                crefito: document.getElementById('configCrefito').value.trim(),
                clinicName: document.getElementById('configClinic').value.trim() || 'ASM Fisioterapia',
                pix: document.getElementById('configPix').value.trim()
            };
            
            if (!userData.config.professionalName || !userData.config.crefito) {
                alert('Preencha nome e CREFITO!');
                return;
            }
            
            await saveUserData();
        }

        // UTILIT√ÅRIOS
        function formatDateBR(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function logout() {
            if (confirm('Deseja sair do sistema?')) {
                localStorage.removeItem('asm_activation');
                location.reload();
            }
        }

        function initializeComponents() {
            // Inicializar assinaturas quando necess√°rio
        }

        // Fechar modais ao clicar fora
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
